{% extends 'base.html' %} 
{% load crispy_forms_tags %}

{% block extra_css %}
{% endblock extra_css %}
  
<head>
  <title>Create Project</title>
</head>

<style>
  #upload-form {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
  }

  #fileuploadfield,
  #progress-box,
  #remove-upload-btn {
    margin-bottom: 10px;
  }

  #fileuploadfield {
    order: 1;
  }

  #remove-upload-btn {
    order: 2;
    margin-left: 10px; /* Add margin for space between buttons */
  }

  #progress-box {
    order: 3;
  }

  #createProjectBtn {
    order: 4;
  }

  #icon {
    height: 35px;
  }

  .overlay-span {
    line-height: 1.1 !important;
    display: inline-block;
  }
</style>

{% block main %}
<!-- SheetJS library for Excel file parsing -->
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

<h1>Create New Project</h1>

{% if alert_message %}
<div class="alert alert-danger" role="alert">{{ alert_message }}</div>
{% endif %}

<div
  class="alert alert-danger alert-dismissible"
  role="alert"
  id="upload_failed"
  style="display:none;">
  No File Selected, Please select a file using the "Browse" button and try again.
</div>

{% if user.is_authenticated %}
<div id="alert-box"></div>

<form method="post" enctype="multipart/form-data" id="upload-form">
  {% csrf_token %}
  
      {% for field in run %}
          {% if field.name == 'alias' %}
          <div style="border-top: 1px solid #000; margin: 20px 0;"></div>
          <p>Enter an unique alias for this project. It can be used to access this project.</p> <p></p>
              <div style='display:flex; gap:5px; align-items:center;'>
                  <span> ampliconrepository.org/project/</span>
                  <div style = 'width:200px; padding:2px; font-size:15px border:1px;'>{{ field }}</div>
                  <span>/</span>
              </div>
              <div id='result'></div>
              <br>
              <br>
              <div style="border-top: 1px solid #000; margin: 20px 0;"></div>
          {% else %}
            {% if field.name != 'accept_license' %}
              {{field | as_crispy_field }}
            {% endif %}
          {% endif %}
      {% endfor %}
  <div class="uk-margin">
          <div class="alert alert-info" role="alert" style="margin-bottom: 15px;">
        <strong>üì¶ What to upload:</strong> A <code>.tar.gz</code> of your AmpliconSuite-pipeline output files.
        <button class="btn btn-link btn-sm" type="button" data-toggle="collapse" data-target="#uploadHelp"
                aria-expanded="false" style="padding: 0; font-size: 1em; vertical-align: baseline;">
            Expand details ‚Üí
        </button>
        <div class="collapse" id="uploadHelp" style="margin-top: 10px;">
            <p style="margin-bottom: 8px;">Include CNVkit directories, AmpliconArchitect output directories, and AmpliconClassifier directories.
               To package your files:</p>
            <pre style="background-color: #f8f9fa; padding: 10px; border-radius: 4px; font-size: 0.85em;"><code>tar --exclude='*.gz' --exclude='*.bam*' -czf project_name.tar.gz your_consolidated_directory/</code></pre>
            <small class="text-muted">‚ö†Ô∏è Do not include .fastq or .bam files. See <a href="https://docs.ampliconrepository.org/en/latest/getting-started/" target="_blank">documentation</a> for details.</small>
        </div>
    </div>

    <div id="file-drop-area" class="uk-placeholder uk-text-center js-upload">
      <span uk-icon="icon: cloud-upload"></span>
      <span class="uk-text-middle">Drag files here or</span>
      <div uk-form-custom>
        <input id="fileuploadfield" type="file" name="document" multiple />
        <span class="uk-link">select files</span>
      </div>
    </div>
  </div>

  <table class="uk-table uk-table-divider" id="file-list-table">
    <!-- UIkit JS -->
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.21.5/dist/js/uikit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.21.5/dist/js/uikit-icons.min.js"></script>
    <!-- UIkit CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.21.5/dist/css/uikit.min.css" />
    <thead>
      <tr>
        <th>File Name</th>
        <th>File Size</th>
        <th>Remove</th>
      </tr>
    </thead>
    <tbody id="file-list"></tbody>
  </table>

  <br /><br />

  <!-- Ensure the progress bar is visible initially -->
  <div id="progress-container">
    <progress id="upload-progressbar" class="uk-progress" value="0" max="100" hidden></progress>
  </div>
  <div style="border-top: 1px solid #000; margin: 20px 0;"></div>

  {% comment %} Accordion for the add metadata stuff {% endcomment %}
  <div id="accordion">
    <div class="card">
        <style>
            .btn-link:not([aria-expanded="false"]).collapsed::before {
                content: "";
                display: inline-block;
                border-style: solid;
                border-width: 0.4em 0 0.4em 0.4em;
                border-color: transparent transparent transparent #000;
                margin-right: 0.5em;
                transform: rotate(0deg);
                vertical-align: middle;
            }

            .btn-link[aria-expanded="true"]::before {
                content: "";
                display: inline-block;
                border-style: solid;
                border-width: 0.4em 0 0.4em 0.4em;
                border-color: transparent transparent transparent #000;
                margin-right: 0.5em;
                transform: rotate(90deg);
                vertical-align: middle;
            }

            .btn-link:not([aria-expanded="true"]).collapsed::before {
                content: "";
                display: inline-block;
                border-style: solid;
                border-width: 0.4em 0 0.4em 0.4em;
                border-color: transparent transparent transparent #000;
                margin-right: 0.5em;
                transform: rotate(0deg);
                vertical-align: middle;
            }

            .table-not-striped tbody tr:nth-of-type(odd) {
                background-color: transparent!important;
            }
            .table-not-striped  th {
                background-color: #E6EFFB;
                color: #696a6c
            }
            .table-not-striped td {
                color: #696a6c
            }
            .navbar-brand {
                min-width: 221px !important;
            }

          /* Fix for header alignment */
            header .navbar-nav .nav-link {
                position: relative !important;
                left: 0 !important;
            }
        </style>
        <div class="card-header" id="addMetadataHeader">
            <h5 class="mb-0">
                <button class="btn btn-link collapsed" data-toggle="collapse" data-target="#addMetadataContent" aria-expanded="false" aria-controls="addMetadataContent" style="padding: 0.25rem 0.5rem;">
                    Add Metadata (optional)
                </button>
            </h5>
        </div>

        <div id="addMetadataContent" class="collapse" aria-labelledby="addMetadataHeader" data-parent="#accordion">
            <div class="card-body">
                <p>
                    Please upload a file in one of the following formats:
                    <ul>
                        <li><strong>CSV:</strong> Comma-separated values file.</li>
                        <li><strong>TSV:</strong> Tab-separated values file.</li>
                        <li><strong>XLSX:</strong> Excel spreadsheet file.</li>
                    </ul>
                </p>
                <p>
                    Ensure that:
                    <ul>
                        <li><strong>The first column</strong> is <b>"sample_name"</b> (e.g., "Sample_001").</li>
                        <li><strong>The second column</strong> is <b>"cancer_type"</b> (e.g., "Lung Cancer").</li>
                        <li><strong>All other columns</strong> are metadata fields associated with the sample.</li>
                        <li>If a column named <strong>sample_name_alias</strong> is included, you will have the option of renaming samples names to the alias names after the project is created.</li>
                        
                    </ul>
                </p>

                <table class="table table-bordered table-striped">
                    <thead class="thead-dark">
                        <tr>
                            <th>sample_name</th>
                            <th>cancer_type</th>
                            <th>sample_type</th>
                            <th>tissue_source_site</th>
                            <th>race</th>
                            <th>ethnicity</th>
                            <th>tumor_stage</th>
                            <th>... (additional columns)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Sample_001</td>
                            <td>Lung Cancer</td>
                            <td>Tumor</td>
                            <td>Lung</td>
                            <td>Asian</td>
                            <td>Hispanic</td>
                            <td>Stage II</td>
                            <td>...</td>
                        </tr>
                        <tr>
                            <td>Sample_002</td>
                            <td>Breast Cancer</td>
                            <td>Normal</td>
                            <td>Breast</td>
                            <td>White</td>
                            <td>Non-Hispanic</td>
                            <td>Stage I</td>
                            <td>...</td>
                        </tr>
                    </tbody>
                </table>

                <h4>Note: Supported file types are <b>.csv</b>, <b>.tsv</b>, and <b>.xlsx</b>. Ensure your file is properly formatted!</h4>
                <hr>
                <div style="margin-bottom: 5px;">
                    <label for="metadataFileInput">Upload Metadata File:</label>
                    <input id="metadataFileInput" type="file" name="metadataFile" accept=".csv, .xlsx, .tsv">
                </div>
                
                <!-- Checkbox for sample_name_alias remapping -->
                <div id="remapSampleNamesDiv" style="display: none; margin-top: 15px; padding: 10px; background-color: #f0f8ff; border: 1px solid #ccc; border-radius: 4px;">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="remap_sample_names" id="remapSampleNamesCheckbox" value="true">
                        <label class="form-check-label" for="remapSampleNamesCheckbox">
                            <strong>Remap sample_names with sample_name_alias from metadata</strong>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>
  </div>

  <div style="border-top: 1px solid #000; margin: 20px 0;"></div>
  {{run.accept_license | as_crispy_field }}


  <input
    type="button"
    onClick="clearFileInput();"
    value="Remove Upload"
    id="remove-upload-btn"
  />

  <button id="createProjectBtn" class="uk-button uk-button-primary" onClick="uploadFiles();" disabled>
    Submit
  </button>
  <button id="createEmptyProjectBtn" class="uk-button uk-button-secondary" onClick="createEmptyProject();" disabled>
    Create Empty Project
  </button>  
</form>

<br />

<p>
  <b>Need help?</b> <br />
  Please do not hesitate to
  <a href="https://github.com/AmpliconSuite/AmpliconRepository/issues"
    >reach out</a
  >, we're very responsive.
</p>

{% else %}
<p>Sign in to Upload Files</p>
{% endif %}

<!-- Overlay for upload progress -->
<div id="upload-overlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:9999; justify-content:center; align-items:flex-start;">
  <div style="background:white; max-width:500px; width:100%; box-sizing:border-box; margin:auto; margin-top:30px; padding:40px 30px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.2); font-size:1.5em; text-align:center;">
    Project creation in progress<br><br>
    <br/>
      <span class="uk-spinner" uk-spinner="ratio:2"></span>
  </div>
</div>

<script>
 const uploadForm = document.getElementById('upload-form');
    const input = document.getElementById('fileuploadfield');
    const alertBox = document.getElementById('alert-box');
    const csrf = document.getElementsByName('csrfmiddlewaretoken');
    const fileList = document.getElementById('file-list');
    const fd = new FormData();
    let filesArray = [];
  
    function addFilename(filename) {
      if (filesArray.some(file => file.name === filename)) {
          console.log(`Filename "${filename}" already exists.`);
          return true;
      } else {
          console.log(`Filename "${filename}" added.`);
          return false;
      }
    }
  
    input.addEventListener('change', (event) => {
      const validFileExtension = ".tar.gz";
      const files = Array.from(input.files);
      let allFilesValid = true;
      let invalidFileNames = [];
      let largeFiles = [];

      // Validate all selected files
      files.forEach(file => {
          const fileName = file.name;
          if (!fileName.toLowerCase().endsWith(validFileExtension)) {
              allFilesValid = false;
              invalidFileNames.push(fileName);
          }
          // Check file size > 1GB (1073741824 bytes)
          if (file.size >1073741824) {
              largeFiles.push(fileName);
          }
      });

      if (!allFilesValid) {
          alert("Sorry, the following files are invalid inputs:\n\n" + invalidFileNames.join(', ') + "\n\nPlease select .tar.gz files only.\n\nSee bottom of page for instructions on how to generate an aggregated input file.");
          throw new Error("Bad file extension!");
      }

      if (largeFiles.length > 0) {
          alert("Warning: The following file(s) are larger than 1GB and may be too large to upload. Please contact the site administrator for assistance.\n\n" + largeFiles.join(', '));
      }

      // Append new files to the array
      files.forEach(file => {
          if (!addFilename(file.name)) {
              filesArray.push(file);
              addFileRow(file);
          }
      });
  
      updateFileInput(); // Update the file input with the current filesArray
      updateSubmitButtonState(); // Revalidate and update button state after files are selected
    });
  
    function clearFileInput() {
      filesArray = [];
      fileList.innerHTML = '';
      input.value = '';
      document.getElementById('js-progressbar').hidden = true;
    }
  
    function addFileRow(file) {
      const row = document.createElement('tr');
      row.innerHTML = `
          <td class='filename'>${file.name}</td>
          <td class="filesize-cell">${(file.size / 1024 / 1024).toFixed(2)} MB</td>
          <td><button class="remove-btn">Remove</button></td>
      `;
      fileList.appendChild(row);
  
      const removeBtn = row.querySelector('.remove-btn');
      removeBtn.addEventListener('click', () => {
          row.remove();
          removeFileFromArray(file.name);
      });
      updateSubmitButtonState();
    }
  
    function removeFileFromArray(fileName) {
      filesArray = filesArray.filter(file => file.name !== fileName);
      updateFileInput();
      updateSubmitButtonState();
    }
  
    function updateFileInput() {
      const dataTransfer = new DataTransfer();
      filesArray.forEach(file => {
          dataTransfer.items.add(file);
      });
      input.files = dataTransfer.files;
    }
  
    function updateProgress(fileName, percent) {
      const rows = fileList.querySelectorAll('tr');
      rows.forEach(row => {
        if (row.querySelector('.filename').textContent === fileName) {
          row.querySelector('.progress-cell').textContent = percent + '%';
        }
      });
    }

    function showUploadOverlay() {
      document.getElementById('upload-overlay').style.display = 'flex';
    }

    function hideUploadOverlay() {
      document.getElementById('upload-overlay').style.display = 'none';
    }
  
    function uploadFiles() {
      showUploadOverlay();
      const fd = new FormData();
      fd.append('csrfmiddlewaretoken', csrf[0].value);
  
      filesArray.forEach(file => {
        fd.append('document', file);
      });
      
      // Add metadata file if selected
      const metadataFileInput = document.getElementById('metadataFileInput');
      if (metadataFileInput && metadataFileInput.files.length > 0) {
        const metadataFile = metadataFileInput.files[0];
        fd.append('metadataFile', metadataFile);
      }
      
      // Add the remap_sample_names checkbox value if checked
      const remapCheckbox = document.getElementById('remapSampleNamesCheckbox');
      if (remapCheckbox && remapCheckbox.checked) {
        fd.append('remap_sample_names', 'true');
      }
  
      const xhr = new XMLHttpRequest();
      xhr.open('POST', uploadForm.action, true);
      xhr.setRequestHeader('X-CSRFToken', csrf[0].value);
  
      alertBox.innerHTML = `<div class="alert alert-info" role="alert">
        Uploading ... Will redirect automatically in a few seconds. 
          </div>`;
      
      xhr.upload.addEventListener('progress', (event) => {
          if (event.lengthComputable) {
              const percent = Math.round((event.loaded / event.total) * 100);
              document.getElementById('js-progressbar').value = percent;
              document.getElementById('js-progressbar').hidden = false;
          }
      });
  
      xhr.onload = function () {
          hideUploadOverlay();
          if (xhr.status >= 200 && xhr.status < 300) {
              alertBox.innerHTML = `<div class="alert alert-success" role="alert">
                                      Successfully uploaded file(s)
                                    </div>`;
              document.getElementById('js-progressbar').hidden = true;
              clearFileInput(); // Clear the input after successful upload
          } else {
              alertBox.innerHTML = `<div class="alert alert-danger" role="alert">
                                      Something went wrong with the upload.
                                    </div>`;
          }
      };
  
      xhr.onerror = function () {
          hideUploadOverlay();
          alertBox.innerHTML = `<div class="alert alert-danger" role="alert">
                                  Something went wrong with the upload.
                                </div>`;
      };
  
     //xhr.send(fd);
    }

    function validateForm() {
      // Add form validation logic here
      return true;
    }

    function validateFiles() {
      return filesArray.length > 0; // Ensure at least one valid file is selected
    }

    function createEmptyProject() {
      const originalAction = uploadForm.action;
      uploadForm.action = "{% url 'create_empty_project' %}";
      if (!document.getElementById('id_project_name').value) {
        alert("Please enter a project name");
        return false;
     }
      if (!document.getElementById('id_project_description').value) {
        alert("Please enter a project description");
        return false;
     }
      // Submit the form
      uploadForm.submit();
      
      // Reset the form's action (optional, helps if the user returns to this page)
      setTimeout(() => {
        uploadForm.action = originalAction;
      }, 100);
    }

    // Update the existing function to also handle the empty project button
    function updateSubmitButtonState() {
      const licenseAccepted = document.getElementById('id_accept_license').checked;
      const hasFiles = filesArray.length > 0;
      
      // Regular project button - requires files and license
      if (licenseAccepted && hasFiles) {
        createProjectBtn.disabled = false;
      } else {
        createProjectBtn.disabled = true;
      }
      
      // Empty project button - requires license but should be disabled if files are present
      if (licenseAccepted && !hasFiles) {
        createEmptyProjectBtn.disabled = false;
      } else {
        createEmptyProjectBtn.disabled = true;
      }
    }

    // Function to check if metadata file contains sample_name_alias column
    function checkForSampleNameAlias(file) {
        const fileName = file.name.toLowerCase();
        const remapDiv = document.getElementById('remapSampleNamesDiv');
        
        if (fileName.endsWith('.csv') || fileName.endsWith('.tsv')) {
            // Read CSV/TSV file
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const delimiter = fileName.endsWith('.tsv') ? '\t' : ',';
                const lines = text.split('\n');
                
                if (lines.length > 0) {
                    // Get header row and check for sample_name_alias (case insensitive)
                    const headers = lines[0].split(delimiter).map(h => h.trim().toLowerCase());
                    if (headers.includes('sample_name_alias')) {
                        remapDiv.style.display = 'block';
                    } else {
                        remapDiv.style.display = 'none';
                    }
                }
            };
            reader.readAsText(file);
        } else if (fileName.endsWith('.xlsx')) {
            // For Excel files, use SheetJS
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    // Try to use SheetJS if available
                    if (typeof XLSX !== 'undefined') {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                        
                        if (jsonData.length > 0) {
                            const headers = jsonData[0].map(h => String(h).toLowerCase());
                            if (headers.includes('sample_name_alias')) {
                                remapDiv.style.display = 'block';
                            } else {
                                remapDiv.style.display = 'none';
                            }
                        }
                    } else {
                        // SheetJS not available, show warning and hide checkbox
                        console.warn('SheetJS library not loaded. Cannot check Excel file for sample_name_alias column.');
                        remapDiv.style.display = 'none';
                    }
                } catch (error) {
                    console.error('Error reading Excel file:', error);
                    remapDiv.style.display = 'none';
                }
            };
            reader.readAsArrayBuffer(file);
        }
    }



    document.addEventListener('DOMContentLoaded', function() {
        // Pass the alias names from Django context to JavaScript
        var aliasNames = JSON.parse("{{ all_alias | escapejs}}");
        console.log(aliasNames);
        
        var inputField = document.getElementById('id_alias');
        var result = document.getElementById('result');
        
        inputField.addEventListener('input', function() {
            var userInput = inputField.value;
            
            if (aliasNames.includes(userInput) ) {
                result.textContent = 'Alias already taken ...';
                result.style.color = 'red';
            } else {
                result.textContent = 'This alias works!';
                result.style.color = 'green';
            }
        });
        const licenseCheckbox = document.getElementById('id_accept_license');
        licenseCheckbox.addEventListener('change', updateSubmitButtonState);
          
        //  call it initially to set correct state
        updateSubmitButtonState();
        
        // Add event listener for metadata file to check for sample_name_alias column
        const metadataInput = document.getElementById('metadataFileInput');
        if (metadataInput) {
            metadataInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    checkForSampleNameAlias(file);
                } else {
                    // Hide the checkbox if no file is selected
                    document.getElementById('remapSampleNamesDiv').style.display = 'none';
                }
            });
        }
    });





</script>

{% endblock main %}