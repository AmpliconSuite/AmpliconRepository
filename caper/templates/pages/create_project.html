{% extends 'base.html' %}

{% load crispy_forms_tags%}

<head>
    <title>
        Create Project
    </title>




</head>
{% block main %}

    <script>
        function showWaitCursor() {
            document.body.style.cursor = 'wait';
            // force it on the button that is being clicked
            checkinputfield();
            $(".btn").css("cursor", "wait");
            return false
        }

        function checkinputfield(){
            var fileInput = document.getElementById('fileuploadfield');
            var progressBar = document.getElementById('progressBar');
            if( document.getElementById("fileuploadfield").files.length == 0 ){
                console.log("no files selected");
                document.getElementById("upload_failed").style.display = "flex";
                return false
            } else{
                console.log(document.getElementById("fileuploadfield").files);
                console.log("file is uploaded");
                var formData = new FormData();
                formData.append('document', fileInput.files[0]);

                fetch('./tmp/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',  // Include CSRF token if using Django
                    },
                    processData: false,
                })
                .then(response => response.json())
                .then(data => {
                    // Handle the response data
                    console.log(data);

                    // Update the progress bar
                    if (progressBar) {
                        progressBar.value = data.progress;
                    } else {
                        console.error("progress bar doesn't exist");
                    }

                    // Check if the upload is complete
                    if (data.progress === 100) {
                        alert('Upload complete!');
                        // Continue with any additional logic
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });

                return true
            }
        }
        function showProgressBar() {
            var progressBar = document.getElementById('progressBar');
            if (progressBar) {
                progressBar.style.display = 'block';
            } else {
                console.error("progress bar doesn't exist")
            }
        }
    </script>
<h1>Create New Project</h1>

<div class="alert alert-danger alert-dismissible" role="alert" id="upload_failed" style="display:none; flex;">
    No File Selected, Please select a file using the "Choose File" button at the bottom of the form and try again.
</div>


{% if user.is_authenticated %}
<form method="post" enctype="multipart/form-data" onsubmit="return checkinputfield();">
    {% csrf_token %}
    {{ run|crispy }}

    <input type="file" name="document" id="fileuploadfield">

    <button class="btn btn-primary" onclick="showProgressBar()">Create Project</button>
    <progress id="progressBar" value="0" max="100" style="display: none;"></progress>

</form>
    <br>
    <p><b>What file do I upload?</b> <br> A specifically structured .tar.gz of your AmpliconSuite-pipeline output files, including all samples in your project.
        To make this file, you must run <a href="https://github.com/AmpliconSuite/AmpliconSuiteAggregator">AmpliconSuiteAggregator</a>.
        The aggregated .tar.gz file will contain organized output files, and a JSON index the site knows how to read. It will disinclude .fastq and .bam files from this packaging.
        Please refer to the <a href="https://docs.ampliconrepository.org/en/latest/getting-started/">documentation</a> for more detailed instructions.</p>

    <p><b>Quickest way to run the Aggregator on my files?</b> <br> AmpliconSuiteAggregator can be run via the <a href="https://genepattern.ucsd.edu/">GenePattern</a> interface.
        Search for "AmpliconSuiteAggregator" after signing in, and upload a .tar.gz or .zip file containing the outputs produced by AmpliconSuite-pipeline.
        Please make sure the .bam and .fastq files are not included when you make your initial .tar.gz or .zip.</p>

    <p>For files larger than 250Mb, please consider uploading directly to the site with the AmpliconSuiteAggregator tool (no need to use this page in that event).</p>

    <p><b>Need help?</b> <br> Please do not hesitate to <a href="https://github.com/AmpliconSuite/AmpliconRepository/issues">reach out</a>, we're very responsive.</p>




{% else %}
<p>Sign in to Upload Files</p>
{% endif %}

{% endblock %}
