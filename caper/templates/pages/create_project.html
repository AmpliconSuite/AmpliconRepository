{% extends 'base.html' %}

{% load crispy_forms_tags%}

<head>
    <title>Create Project</title>
</head>

{% block extra_js %}
<script>

    function clearFileInput() {
        const ctrl = document.getElementById('fileuploadfield');
        const progressBox = document.getElementById('progress-box')
        progressBox.style.display = "none";

        try {
          ctrl.value = null;
        } catch(ex) { }
        if (ctrl.value) {
          ctrl.parentNode.replaceChild(ctrl.cloneNode(true), ctrl);
        }
      }

    
    var _validFileExtensions = [".tar.gz"];    
    function Validate(oForm) {
        var arrInputs = oForm.getElementsByTagName("input");
        for (var i = 0; i < arrInputs.length; i++) {
            var oInput = arrInputs[i];
            if (oInput.type == "file") {
                var sFileName = oInput.value;
                if (sFileName.length > 0) {
                    var blnValid = false;
                    for (var j = 0; j < _validFileExtensions.length; j++) {
                        var sCurExtension = _validFileExtensions[j];
                        if (sFileName.substr(sFileName.length - sCurExtension.length, sCurExtension.length).toLowerCase() == sCurExtension.toLowerCase()) {
                            blnValid = true;
                            break;
                        }
                    }
                    
                    if (!blnValid) {
                        alert("Sorry, " + sFileName + " is invalid, allowed extensions are: " + _validFileExtensions.join(", ") + "\n Please Re-Upload with the correct file.");
                        return false;
                    }
                }
            }
        }
    
        return true;
    }

</script>

    
{% endblock extra_js %}
    

{% block main %}

<h1>Create New Project</h1>

<div class="alert alert-danger alert-dismissible" role="alert" id="upload_failed" style="display:none; flex;">
    No File Selected, Please select a file using the "Choose File" button at the bottom of the form and try again.
</div>

{% if user.is_authenticated %}
    <div id="alert-box"></div>
    <form method="post" enctype="multipart/form-data" id="upload-form" onsubmit="return Validate(this);">
        {% csrf_token %}
        {{ run|crispy }}

        <input type="file" name="document" id="fileuploadfield">
        <div id="progress-box" class="not-visible"></div>
        <br>
        <br>
        <input type="button" onClick="clearFileInput();" value = "Remove Upload">
        <br>

        
{#        <div id="cancel-box" class="not-visible">#}
{#            <button id="cancel-btn" class="btn btn-danger">cancel</button>#}
{#        </div>#}
        <br>
        <button id="createProjectBtn" class="btn btn-primary">Create Project</button>

    </form>


    <br>
    <p><b>What file do I upload?</b> <br> A specifically structured .tar.gz of your AmpliconSuite-pipeline output files, including all samples in your project.
        To make this file, you must run <a href="https://github.com/AmpliconSuite/AmpliconSuiteAggregator">AmpliconSuiteAggregator</a>.
        The aggregated .tar.gz file will contain organized output files, and a JSON index the site knows how to read. It will disinclude .fastq and .bam files from this packaging.
        Please refer to the <a href="https://docs.ampliconrepository.org/en/latest/getting-started/">documentation</a> for more detailed instructions.</p>

    <p><b>Quickest way to run the Aggregator on my files?</b> <br> AmpliconSuiteAggregator can be run via the <a href="https://genepattern.ucsd.edu/">GenePattern</a> interface.
        Search for "AmpliconSuiteAggregator" after signing in, and upload a .tar.gz or .zip file containing the outputs produced by AmpliconSuite-pipeline.
        Please make sure the .bam and .fastq files are not included when you make your initial .tar.gz or .zip.</p>

    <p>For files larger than 250Mb, please consider uploading directly to the site with the AmpliconSuiteAggregator tool (no need to use this page in that event).</p>

    <p><b>Need help?</b> <br> Please do not hesitate to <a href="https://github.com/AmpliconSuite/AmpliconRepository/issues">reach out</a>, we're very responsive.</p>


{% else %}
    <p>Sign in to Upload Files</p>
{% endif %}
<script>
    const uploadForm = document.getElementById('upload-form')
    const input = document.getElementById('fileuploadfield')
    console.log(input)

    const alertBox = document.getElementById('alert-box')
    const progressBox = document.getElementById('progress-box')
    {#const cancelBox = document.getElementById('cancel-box')#}
    {#const cancelBtn = document.getElementById('cancel-btn')#}

    const csrf = document.getElementsByName('csrfmiddlewaretoken')

    input.addEventListener('change', () => {
        progressBox.classList.remove('not-visible')
        progressBox.style.display = "block";
        {#cancelBox.classList.remove('not-visible')#}

        const agg_file = input.files[0]
        const url = URL.createObjectURL(agg_file)
        console.log(agg_file, "agg_file")
        console.log(url, "url")

        const fd = new FormData()
        fd.append('csrfmiddlewaretoken', csrf[0].value)
        fd.append('document', agg_file)

        $.ajax({
            type:'POST',
            url: uploadForm.action,
            enctype: 'multipart/form-data',
            data: fd,
            beforeSend: function(){
                console.log('before')
                alertBox.innerHTML= ""
            },
            xhr: function(){
                const xhr = new window.XMLHttpRequest();
                xhr.upload.addEventListener('progress', (e) => {
                    // console.log(e)
                    if (e.lengthComputable) {
                        const percent = e.loaded / e.total * 100
                        console.log(percent, "% up")
                        progressBox.innerHTML = `<div class="progress">
                                                    <div class="progress-bar" role="progressbar" style="width: ${percent}%" aria-valuenow="${percent}" aria-valuemin="0" aria-valuemax="100"></div>
                                                </div>
                                                <p>${percent.toFixed(1)}%</p>`
                    }

                })
                {#cancelBtn.addEventListener('click', ()=>{#}
                {#    xhr.abort()#}
                {#    setTimeout(()=>{#}
                {#        uploadForm.reset()#}
                {#        progressBox.innerHTML=""#}
                {#        alertBox.innerHTML = ""#}
                {#        cancelBox.classList.add('not-visible')#}
                {#    }, 2000)#}
                {# })#}
                return xhr
            },
            success: function(response){
                console.log(response)
                alertBox.innerHTML = `<div class="alert alert-success" role="alert">
                                        Successfully uploaded file
                                    </div>`
                {#cancelBox.classList.add('not-visible')#}
            },
            error: function(error){
                console.log(error)
                alertBox.innerHTML = `<div class="alert alert-danger" role="alert">
                                        Ups... something went wrong
                                    </div>`
            },
            cache: false,
            contentType: false,
            processData: false,
        })
    })



    
</script>

{% endblock %}
