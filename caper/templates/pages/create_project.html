{% extends 'base.html' %} 
{% load crispy_forms_tags %}


{% block extra_css %}
  

{% endblock extra_css %}
  
<head>
  <title>Create Project</title>
  <!-- <link rel="stylesheet" href="https://rsms.me/inter/inter.css" /> -->

  

  
</head>

<style>
  #upload-form {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
  }

  #fileuploadfield,
  #progress-box,
  #remove-upload-btn {
    margin-bottom: 10px;
  }

  #fileuploadfield {
    order: 1;
  }

  #remove-upload-btn {
    order: 2;
    margin-left: 10px; /* Add margin for space between buttons */
  }

  #progress-box {
    order: 3;
  }

  #createProjectBtn {
    order: 4;
  }

  #icon{
    height: 35px;
  }

</style>

{% block main %}


<h1>Create New Project</h1>

{% if alert_message %}
<div class="alert alert-danger" role="alert">{{ alert_message }}</div>
{% endif %}

<div
  class="alert alert-danger alert-dismissible"
  role="alert"
  id="upload_failed"
  style="display:none;">
  No File Selected, Please select a file using the "Browse" button and try again.
</div>

{% if user.is_authenticated %}
<div id="alert-box"></div>
<form method="post" enctype="multipart/form-data" id="upload-form">
  {% csrf_token %} {{ run | crispy }}
  <div class="uk-margin">
    <div id="file-drop-area" class="uk-placeholder uk-text-center js-upload">
      <span uk-icon="icon: cloud-upload"></span>
      <span class="uk-text-middle">Drag files here or</span>
      <div uk-form-custom>
        <input id="fileuploadfield" type="file" name="document" multiple />
        <span class="uk-link">select files</span>
      </div>
    </div>
  </div>
  <table class="uk-table uk-table-divider" id="file-list-table">
    <!-- UIkit JS -->
  <script src="https://cdn.jsdelivr.net/npm/uikit@3.21.5/dist/js/uikit.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/uikit@3.21.5/dist/js/uikit-icons.min.js"></script>
  <!-- UIkit CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.21.5/dist/css/uikit.min.css"/>
    <thead>
      <tr>
        <th>File Name</th>
        <th>File Size</th>
        <th>Remove</th>
      </tr>
    </thead>
    <tbody id="file-list"></tbody>
  </table>

  <br />
  <br />

  <progress id="js-progressbar" class="uk-progress" value="0" max="100" hidden></progress>

  <input
    type="button"
    onClick="clearFileInput();"
    value="Remove Upload"
    id="remove-upload-btn"
  />

  <button id="createProjectBtn" class="uk-button uk-button-primary" onClick="uploadFiles();" disabled>
    Submit
  </button>
</form>
<br />
<p>
  <b>What file do I upload?</b> <br />
  A specifically structured .tar.gz of your AmpliconSuite-pipeline output files,
  including all samples in your project. To make this file, you must run
  <a href="https://github.com/AmpliconSuite/AmpliconSuiteAggregator"
    >AmpliconSuiteAggregator</a
  >. The aggregated .tar.gz file will contain organized output files, and a JSON
  index the site knows how to read. It will disinclude .fastq and .bam files
  from this packaging. Please refer to the
  <a href="https://docs.ampliconrepository.org/en/latest/getting-started/"
    >documentation</a
  >
  for more detailed instructions.
</p>

<p>
  <b>Quickest way to run the Aggregator on my files?</b> <br />
  AmpliconSuiteAggregator can be run via the
  <a href="https://genepattern.ucsd.edu/">GenePattern</a> interface. Search for
  "AmpliconSuiteAggregator" after signing in, and upload a .tar.gz or .zip file
  containing the outputs produced by AmpliconSuite-pipeline. Please make sure
  the .bam and .fastq files are not included when you make your initial .tar.gz
  or .zip.
</p>

<p>
  For files larger than 250Mb, please consider uploading directly to the site
  with the AmpliconSuiteAggregator tool (no need to use this page in that
  event).
</p>

<p>
  <b>Need help?</b> <br />
  Please do not hesitate to
  <a href="https://github.com/AmpliconSuite/AmpliconRepository/issues"
    >reach out</a
  >, we're very responsive.
</p>

{% else %}
<p>Sign in to Upload Files</p>
{% endif %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const input = document.getElementById("fileuploadfield");
        const createProjectBtn = document.getElementById("createProjectBtn");
        const alertBox = document.getElementById("alert-box");
        const fileList = document.getElementById("file-list");
        const form = document.getElementById("upload-form");
      
        let filesArray = [];
      
        function validateForm() {
          // Add form validation logic here
          // This function should return `true` if all form fields are valid, `false` otherwise.
          // For simplicity, let's assume the form is always valid (you can adjust this as needed).
          return true;
        }
      
        function validateFiles() {
          return filesArray.length > 0; // Ensure at least one valid file is selected
        }
      
        function updateSubmitButtonState() {
          if (validateForm() && validateFiles()) {
            createProjectBtn.disabled = false; // Enable button if both are valid
          } else {
            createProjectBtn.disabled = true; // Keep button disabled otherwise
          }
        }
      
        function addFilename(filename) {
          return filesArray.some(file => file.name === filename);
        }
      
        input.addEventListener("change", (event) => {
          const validFileExtension = ".tar.gz";
          const files = Array.from(input.files);
          let allFilesValid = true;
          let invalidFileNames = [];
      
          // Validate all selected files
          files.forEach((file) => {
            const fileName = file.name;
            if (!fileName.toLowerCase().endsWith(validFileExtension)) {
              allFilesValid = false;
              invalidFileNames.push(fileName);
            }
          });
      
          if (!allFilesValid) {
            alert("Sorry, the following files are invalid inputs:\n\n" + invalidFileNames.join(", ") + "\n\nPlease select .tar.gz files only.");
            throw new Error("Bad file extension!");
          }
      
          // Append new files to the array
          files.forEach((file) => {
            if (!addFilename(file.name)) {
              filesArray.push(file);
              addFileRow(file);
            }
          });
      
          updateFileInput(); // Update the file input with the current filesArray
          updateSubmitButtonState(); // Revalidate and update button state after files are selected
        });
      
        function clearFileInput() {
          filesArray = [];
          fileList.innerHTML = "";
          input.value = "";
          updateSubmitButtonState(); // Revalidate after clearing
          document.getElementById("js-progressbar").hidden = true;
        }
      
        function addFileRow(file) {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td class='filename'>${file.name}</td>
            <td class="filesize-cell">${(file.size / 1024 / 1024).toFixed(2)} MB</td>
            <td><button class="remove-btn">Remove</button></td>
          `;
          fileList.appendChild(row);
      
          const removeBtn = row.querySelector(".remove-btn");
          removeBtn.addEventListener("click", () => {
            row.remove();
            removeFileFromArray(file.name);
          });
        }
      
        function removeFileFromArray(fileName) {
          filesArray = filesArray.filter(file => file.name !== fileName);
          updateFileInput();
          updateSubmitButtonState(); // Revalidate after removing a file
        }
      
        function updateFileInput() {
          const dataTransfer = new DataTransfer();
          filesArray.forEach(file => {
            dataTransfer.items.add(file);
          });
          input.files = dataTransfer.files;
        }
      
        // Initial check to disable submit button
        updateSubmitButtonState();
      
        // You can also add form field listeners if needed to check validation for other form inputs
        form.addEventListener("input", updateSubmitButtonState);
      });
      
</script>



{% endblock %}
