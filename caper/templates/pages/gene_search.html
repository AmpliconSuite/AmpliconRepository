{% extends 'base.html' %}

{% block extra_css %}
<style>
    .search-container {
        display: flex;
        gap: 20px;
        width: 100%; /* Expand fully to match container width above */
    }
    .search-box {
        width: 30%;
        padding: 20px;
        background-color: #f8f9fa;
        border-radius: 5px;
    }
    .results-container {
        width: 100%;
    }

    /* Project filter styles */
    .project-filters {
        margin-top: 20px;
        padding: 15px;
        background-color: #ffffff;
        border: 1px solid #dee2e6;
        border-radius: 5px;
    }

    .project-filters h5 {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 10px;
        color: #495057;
    }

    .filter-list {
        max-height: 300px;
        overflow-y: auto;
        margin-bottom: 10px;
    }

    .filter-item {
        display: flex;
        align-items: center;
        padding: 5px 0;
        cursor: pointer;
    }

    .filter-item:hover {
        background-color: #f8f9fa;
    }

    .filter-item input[type="checkbox"] {
        margin-right: 8px;
        cursor: pointer;
    }

    .filter-item label {
        margin: 0;
        cursor: pointer;
        flex: 1;
        font-size: 14px;
    }

    .filter-count {
        color: #6c757d;
        font-size: 13px;
        margin-left: 5px;
    }

    .filter-actions {
        display: flex;
        gap: 5px;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #dee2e6;
    }

    .filter-actions button {
        font-size: 12px;
        padding: 4px 8px;
    }

    .no-filters {
        color: #6c757d;
        font-style: italic;
        font-size: 14px;
    }

    mark {
        background-color: #ffeb3b !important; /* Brighter yellow */
        color: black; /* Ensures readability */
        padding: 2px 4px;
        border-radius: 3px;
        font-weight: bold;
    }

    .table td, .table th {
        white-space: normal !important;
        word-wrap: break-word;
        max-width: 200px; /* Adjust this value as needed */
    }

    /* Make sure these styles don't interfere with our custom rendering */
    .gene-content.expanded {
        white-space: normal !important;
        word-wrap: break-word;
    }

    /* Ensure search matches are highlighted */
    .table td mark {
      background-color: #ffeb3b;
      padding: 0 2px;
      border-radius: 2px;
    }

    /* Batch download controls */
    .batch-controls {
        margin-bottom: 15px;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 5px;
        border: 1px solid #e9ecef;
    }

    .selected-count {
        margin-left: 15px;
        font-weight: bold;
    }

    /* Checkbox styling */
    .sample-checkbox {
        cursor: pointer;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function () {
        // Track enabled project filters for each tab
        // Store checked projects - when all are checked, show all samples
        let publicProjectFilters = new Set();
        let privateProjectFilters = new Set();

        // Initialize filter sets with all projects checked (matches the UI state)
        // Do this synchronously BEFORE DataTables initialization
        $('#public-project-filters .project-filter-checkbox').each(function() {
            const projectId = $(this).data('project-id');
            if (projectId) {
                publicProjectFilters.add(String(projectId));
            }
        });
        $('#private-project-filters .project-filter-checkbox').each(function() {
            const projectId = $(this).data('project-id');
            if (projectId) {
                privateProjectFilters.add(String(projectId));
            }
        });

        $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
            $.fn.dataTable.tables({ visible: true, api: true }).columns.adjust();
            
            // Toggle filter panels based on active tab
            const targetTab = $(e.target).attr('href');
            if (targetTab === '#samples-tab' || targetTab === '#projects-tab') {
                $('#public-project-filters').show();
                $('#private-project-filters').hide();
            } else if (targetTab === '#private-samples-tab' || targetTab === '#private-projects-tab') {
                $('#public-project-filters').hide();
                $('#private-project-filters').show();
            }
        });

        // Live search filter
        $("#searchInput").on("keyup", function () {
            let value = $(this).val().toLowerCase();
            $(".results-container table tbody tr").filter(function () {
                $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
            });
        });

        // Get search terms for gene highlighting from Django context
        const searchTerms = [];
        let geneQuery = "";
        {% if user_query.genequery %}
        geneQuery = "{{ user_query.genequery|escapejs }}";
        {% elif gene_query %}
        geneQuery = "{{ gene_query|escapejs }}";
        {% endif %}
        
        if (geneQuery) {
            // Split by OR (|) and AND (&) operators and trim whitespace
            const genes = geneQuery.split(/[|&]/).map(g => g.trim().toUpperCase()).filter(g => g);
            searchTerms.push(...genes);
        }

        // Store project IDs for each row during DataTables initialization
        let rowProjectIds = {};

        // Custom search function for project filtering
        // Register this AFTER filter sets are initialized
        $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
            const tableId = settings.nTable.id;
            let activeFilters;

            // Determine which filter set to use based on table
            if (tableId === 'public-samples-table') {
                activeFilters = publicProjectFilters;
            } else if (tableId === 'private-samples-table') {
                activeFilters = privateProjectFilters;
            } else {
                return true; // No filtering for project tables
            }

            // If no filters active (all unchecked), hide all rows
            if (activeFilters.size === 0) {
                return false;
            }

            // Get project ID from the stored mapping using table and row index
            const rowKey = `${tableId}_${dataIndex}`;
            const projectId = rowProjectIds[rowKey];

            // Show row if its project is in the active filter set
            return activeFilters.has(projectId);
        });

        // Function to apply project filters
        function applyProjectFilters(isPrivate) {
            const table = isPrivate ? $('#private-samples-table').DataTable() : $('#public-samples-table').DataTable();
            const filterSet = isPrivate ? privateProjectFilters : publicProjectFilters;
            const selectAllCheckbox = isPrivate ? $('#private-select-all-checkbox') : $('#public-select-all-checkbox');
            const isSelectAllChecked = selectAllCheckbox.is(':checked');

            // Process all rows
            table.rows().every(function() {
                const row = this.node();
                const $row = $(row);
                const checkbox = $row.find('.sample-checkbox');
                const projectId = String(checkbox.data('project-id'));
                const sampleName = checkbox.data('sample-name');
                const key = `${projectId}:${sampleName}`;

                // Determine if this row will be visible after filtering
                const willBeVisible = filterSet.has(projectId) && filterSet.size > 0;

                if (!willBeVisible) {
                    // Row is being hidden - uncheck it if checked
                    const wasChecked = checkbox.is(':checked');
                    if (wasChecked) {
                        checkbox.prop('checked', false);
                        // Decrement count for this sample
                        if (isPrivate) {
                            const currentCount = privateSelectedSamples.get(key) || 0;
                            if (currentCount <= 1) {
                                privateSelectedSamples.delete(key);
                            } else {
                                privateSelectedSamples.set(key, currentCount - 1);
                            }
                        } else {
                            const currentCount = publicSelectedSamples.get(key) || 0;
                            if (currentCount <= 1) {
                                publicSelectedSamples.delete(key);
                            } else {
                                publicSelectedSamples.set(key, currentCount - 1);
                            }
                        }
                    }
                } else if (willBeVisible && isSelectAllChecked) {
                    // Row is being shown and "select all" is checked
                    const wasChecked = checkbox.is(':checked');
                    if (!wasChecked) {
                        checkbox.prop('checked', true);
                        // Increment count for this sample
                        if (isPrivate) {
                            const currentCount = privateSelectedSamples.get(key) || 0;
                            privateSelectedSamples.set(key, currentCount + 1);
                        } else {
                            const currentCount = publicSelectedSamples.get(key) || 0;
                            publicSelectedSamples.set(key, currentCount + 1);
                        }
                    }
                }
                // If willBeVisible && !isSelectAllChecked: do nothing, keep current state
            });

            // Redraw the table to apply filters
            table.draw();

            // Update the selection count
            if (isPrivate) {
                updatePrivateSelection();
            } else {
                updatePublicSelection();
            }
        }

        // Project filter checkbox change handler
        $(document).on('change', '.project-filter-checkbox', function() {
            const projectId = String($(this).data('project-id'));
            const isPrivate = $(this).hasClass('private-filter');
            const filterSet = isPrivate ? privateProjectFilters : publicProjectFilters;

            if ($(this).is(':checked')) {
                filterSet.add(projectId);
            } else {
                filterSet.delete(projectId);
            }

            applyProjectFilters(isPrivate);
        });

        // Select All filters button
        $(document).on('click', '.select-all-filters', function() {
            const isPrivate = $(this).hasClass('private-filters');
            const filterContainer = isPrivate ? '#private-project-filters' : '#public-project-filters';
            const filterSet = isPrivate ? privateProjectFilters : publicProjectFilters;
            
            $(filterContainer + ' .project-filter-checkbox').prop('checked', true).each(function() {
                const projectId = String($(this).data('project-id'));
                filterSet.add(projectId);
            });

            applyProjectFilters(isPrivate);
        });

        // Clear All filters button
        $(document).on('click', '.clear-all-filters', function() {
            const isPrivate = $(this).hasClass('private-filters');
            const filterContainer = isPrivate ? '#private-project-filters' : '#public-project-filters';
            const filterSet = isPrivate ? privateProjectFilters : publicProjectFilters;
            
            $(filterContainer + ' .project-filter-checkbox').prop('checked', false);
            filterSet.clear();

            applyProjectFilters(isPrivate);
        });

        // Initialize DataTables with custom gene column rendering
        function initializeTable(tableSelector) {
            const table = $(tableSelector);
            if ($.fn.DataTable.isDataTable(table)) return;

            // Find the Genes column index
            let genesColumnIndex = -1;
            table.find('thead th').each(function(index) {
                if ($(this).text().trim() === 'Genes') {
                    genesColumnIndex = index;
                }
            });

            // Initialize DataTable with custom rendering for the genes column
            const dtInstance = table.DataTable({
                paging: true,
                pageLength: 10,
                lengthMenu: [10, 25, 50, 100],
                ordering: true,
                info: true,
                searching: true,
                autoWidth: false,
                responsive: true,
                order: [[1, 'asc']], // Default sort by Project Name column (index 1)
                createdRow: function(row, data, dataIndex) {
                    // Store the project ID for this row so we can access it during filtering
                    const $row = $(row);
                    const projectId = String($row.find('.sample-checkbox').data('project-id'));
                    const tableId = table.attr('id');
                    const rowKey = `${tableId}_${dataIndex}`;
                    rowProjectIds[rowKey] = projectId;
                },
                columnDefs: [
                    {
                        targets: 0,
                        orderable: false // Disable sorting for checkbox column
                    },
                    genesColumnIndex !== -1 ? {
                        targets: genesColumnIndex,
                        render: function(data, type, row) {
                            if (type !== 'display') return data;
                            const genes = data.split(', ');

                            let reorganizedGenes = [...genes];
                            if (searchTerms.length > 0) {
                                const matched = [], other = [];
                                genes.forEach(gene => {
                                    // Use exact match instead of includes to avoid partial matches
                                    // e.g., "EGFR" should not match "EGFR-AS1"
                                    const isMatch = searchTerms.some(term => gene.toUpperCase() === term);
                                    if (isMatch) {
                                        matched.push(`<mark>${gene}</mark>`);
                                    } else {
                                        other.push(gene);
                                    }
                                });
                                if (matched.length > 0) reorganizedGenes = [...matched, ...other];
                            }

                            // If 5 or fewer genes, just display them all
                            if (genes.length <= 5) {
                                return reorganizedGenes.join(', ');
                            }

                            // If more than 5 genes, add expand/collapse functionality
                            return `
                                <div class="gene-container">
                                    <div class="gene-content collapsed">${reorganizedGenes.slice(0, 5).join(', ')}</div>
                                    <div class="gene-content expanded" style="display:none">${reorganizedGenes.join(', ')}</div>
                                    <button class="btn btn-sm btn-link p-0 gene-toggle" style="margin-left:5px;color:blue;">
                                        Show all ${genes.length} genes
                                    </button>
                                </div>
                            `;
                        }
                    } : {}
                ]
            });
        }

        // Initialize all tables
        $('#projects-tab table.table').each(function() { initializeTable(this); });
        $('#samples-tab table.table').each(function() { initializeTable(this); });
        $('#private-projects-tab table.table').each(function() { initializeTable(this); });
        $('#private-samples-tab table.table').each(function() { initializeTable(this); });


        // Handle click on the toggle button
        $(document).on('click', '.gene-toggle', function(e) {
            e.preventDefault();
            e.stopPropagation();

            const container = $(this).closest('.gene-container');
            const collapsedContent = container.find('.gene-content.collapsed');
            const expandedContent = container.find('.gene-content.expanded');

            if (collapsedContent.is(':visible')) {
                collapsedContent.hide();
                expandedContent.show();
                $(this).text('Show less');
            } else {
                expandedContent.hide();
                collapsedContent.show();
                $(this).text(`Show all ${expandedContent.text().split(',').length} genes`);
            }
        });

        // Batch sample download functionality
        // Variables to track selection - use Maps to count checkboxes per sample
        // Key: "projectId:sampleName", Value: count of checked checkboxes for that sample
        let publicSelectedSamples = new Map();
        let privateSelectedSamples = new Map();

        // Get references to the DataTables instances
        const publicTable = $('#samples-tab table').DataTable();
        const privateTable = $('#private-samples-tab table').DataTable();

        // Function to update selected count and button state for public samples
        function updatePublicSelection() {
            const count = publicSelectedSamples.size;
            $('#public-selected-count').text(count + ' sample' + (count !== 1 ? 's' : '') + ' selected');
            $('#download-public-selected').prop('disabled', count === 0);
        }

        // Function to update selected count and button state for private samples
        function updatePrivateSelection() {
            const count = privateSelectedSamples.size;
            $('#private-selected-count').text(count + ' sample' + (count !== 1 ? 's' : '') + ' selected');
            $('#download-private-selected').prop('disabled', count === 0);
        }

        // Handle individual checkbox clicks for public samples
        $(document).on('change', '.public-sample-checkbox', function() {
            const projectId = $(this).data('project-id');
            const sampleName = $(this).data('sample-name');
            const key = `${projectId}:${sampleName}`;

            if ($(this).is(':checked')) {
                // Increment the count for this sample
                const currentCount = publicSelectedSamples.get(key) || 0;
                publicSelectedSamples.set(key, currentCount + 1);
            } else {
                // Decrement the count for this sample
                const currentCount = publicSelectedSamples.get(key) || 0;
                if (currentCount <= 1) {
                    // Remove from map if this was the last checkbox
                    publicSelectedSamples.delete(key);
                } else {
                    publicSelectedSamples.set(key, currentCount - 1);
                }
            }

            updatePublicSelection();
        });

        // Handle individual checkbox clicks for private samples
        $(document).on('change', '.private-sample-checkbox', function() {
            const projectId = $(this).data('project-id');
            const sampleName = $(this).data('sample-name');
            const key = `${projectId}:${sampleName}`;

            if ($(this).is(':checked')) {
                // Increment the count for this sample
                const currentCount = privateSelectedSamples.get(key) || 0;
                privateSelectedSamples.set(key, currentCount + 1);
            } else {
                // Decrement the count for this sample
                const currentCount = privateSelectedSamples.get(key) || 0;
                if (currentCount <= 1) {
                    // Remove from map if this was the last checkbox
                    privateSelectedSamples.delete(key);
                } else {
                    privateSelectedSamples.set(key, currentCount - 1);
                }
            }

            updatePrivateSelection();
        });

        // Public samples - Select All button using DataTables API
        $('#select-all-public').on('click', function() {
            // Clear current selection
            publicSelectedSamples.clear();

            // Process all rows, not just visible ones
            publicTable.rows({ search: 'applied' }).every(function(rowIdx) {
                const row = this.node();
                const checkbox = $(row).find('.public-sample-checkbox');
                const projectId = checkbox.data('project-id');
                const sampleName = checkbox.data('sample-name');

                if (projectId && sampleName) {
                    const key = `${projectId}:${sampleName}`;
                    // Increment count for this sample (to track multiple checkboxes per sample)
                    const currentCount = publicSelectedSamples.get(key) || 0;
                    publicSelectedSamples.set(key, currentCount + 1);
                    checkbox.prop('checked', true);
                }
            });

            // Also check the "select all" checkbox in the header
            $('#public-select-all-checkbox').prop('checked', true);

            updatePublicSelection();
        });

        // Public samples - Deselect All button
        $('#deselect-all-public').on('click', function() {
            publicSelectedSamples.clear();

            // Uncheck all checkboxes, using DataTables API
            publicTable.rows().every(function(rowIdx) {
                const row = this.node();
                $(row).find('.public-sample-checkbox').prop('checked', false);
            });

            $('#public-select-all-checkbox').prop('checked', false);
            updatePublicSelection();
        });

        // Private samples - Select All button using DataTables API
        $('#select-all-private').on('click', function() {
            // Clear current selection
            privateSelectedSamples.clear();

            // Process all rows, not just visible ones
            privateTable.rows({ search: 'applied' }).every(function(rowIdx) {
                const row = this.node();
                const checkbox = $(row).find('.private-sample-checkbox');
                const projectId = checkbox.data('project-id');
                const sampleName = checkbox.data('sample-name');

                if (projectId && sampleName) {
                    const key = `${projectId}:${sampleName}`;
                    // Increment count for this sample (to track multiple checkboxes per sample)
                    const currentCount = privateSelectedSamples.get(key) || 0;
                    privateSelectedSamples.set(key, currentCount + 1);
                    checkbox.prop('checked', true);
                }
            });

            // Also check the "select all" checkbox in the header
            $('#private-select-all-checkbox').prop('checked', true);

            updatePrivateSelection();
        });

        // Private samples - Deselect All button
        $('#deselect-all-private').on('click', function() {
            privateSelectedSamples.clear();

            // Uncheck all checkboxes, using DataTables API
            privateTable.rows().every(function(rowIdx) {
                const row = this.node();
                $(row).find('.private-sample-checkbox').prop('checked', false);
            });

            $('#private-select-all-checkbox').prop('checked', false);
            updatePrivateSelection();
        });

        // Header checkbox: Select/deselect ALL filtered rows across all pages — public samples
        $('#public-select-all-checkbox').on('change', function() {
            const isChecked = $(this).is(':checked');
            publicTable.rows({ search: 'applied' }).every(function() {
                const $row = $(this.node());
                const checkbox = $row.find('.public-sample-checkbox');
                const wasChecked = checkbox.is(':checked');
                checkbox.prop('checked', isChecked);
                const projectId = checkbox.data('project-id');
                const sampleName = checkbox.data('sample-name');
                const key = `${projectId}:${sampleName}`;
                
                if (isChecked && !wasChecked) {
                    // Checkbox being checked - increment count
                    const currentCount = publicSelectedSamples.get(key) || 0;
                    publicSelectedSamples.set(key, currentCount + 1);
                } else if (!isChecked && wasChecked) {
                    // Checkbox being unchecked - decrement count
                    const currentCount = publicSelectedSamples.get(key) || 0;
                    if (currentCount <= 1) {
                        publicSelectedSamples.delete(key);
                    } else {
                        publicSelectedSamples.set(key, currentCount - 1);
                    }
                }
            });
            updatePublicSelection();
        });

        // Header checkbox: Select/deselect ALL filtered rows across all pages — private samples
        $('#private-select-all-checkbox').on('change', function() {
            const isChecked = $(this).is(':checked');
            privateTable.rows({ search: 'applied' }).every(function() {
                const $row = $(this.node());
                const checkbox = $row.find('.private-sample-checkbox');
                const wasChecked = checkbox.is(':checked');
                checkbox.prop('checked', isChecked);
                const projectId = checkbox.data('project-id');
                const sampleName = checkbox.data('sample-name');
                const key = `${projectId}:${sampleName}`;
                
                if (isChecked && !wasChecked) {
                    // Checkbox being checked - increment count
                    const currentCount = privateSelectedSamples.get(key) || 0;
                    privateSelectedSamples.set(key, currentCount + 1);
                } else if (!isChecked && wasChecked) {
                    // Checkbox being unchecked - decrement count
                    const currentCount = privateSelectedSamples.get(key) || 0;
                    if (currentCount <= 1) {
                        privateSelectedSamples.delete(key);
                    } else {
                        privateSelectedSamples.set(key, currentCount - 1);
                    }
                }
            });
            updatePrivateSelection();
        });

        // Function to handle sample download submission
        function downloadSelectedSamples(samples, isPrivate) {
            if (samples.length === 0) return;

            // Check if user is logged in
            if (!{% if user.is_authenticated %}true{% else %}false{% endif %}) {
                // Show login modal or redirect to login page
                alert('You must be logged in to batch download samples from this page. Please log in and try again or visit project pages to download samples.');
                window.location.href = '/accounts/login/?next=' + encodeURIComponent(window.location.pathname);
                return;
            }

            // Check if sample count > 100 to determine if we should email results
            const shouldEmailResults = samples.length > 100;
            const userEmail = "{{ user.email|default:user.username }}";

            // Show loading message or email notification based on sample count
            let loadingModal;
            if (shouldEmailResults) {
                // Show email notification message for large downloads
                // Track if form has been submitted or cancelled
                let formSubmitted = false;
                let cancelled = false;
                
                // Function to handle cancel
                const cancelEmailModal = function(e) {
                    console.log('Cancel button clicked!', e);
                    if (!formSubmitted && !cancelled) {
                        console.log('Cancelling download request');
                        cancelled = true;
                        $('#loadingModal').modal('hide');
                        // Clean up after animation
                        setTimeout(function() {
                            $('#loadingModal').remove();
                            $('.modal-backdrop').remove();
                            $('body').removeClass('modal-open');
                        }, 300);
                    }
                };
                
                // Function to handle send confirmation
                const sendEmailLink = function(e) {
                    console.log('Send Link button clicked!', e);
                    if (!formSubmitted && !cancelled) {
                        console.log('User confirmed - sending email link');
                        formSubmitted = true;
                        
                        // Update modal to show "sending" state
                        $('#loadingModal .modal-body').html(
                            $('<div>').append(
                                $('<div>', {'class': 'spinner-border text-primary mb-3', 'role': 'status'}).append(
                                    $('<span>', {'class': 'sr-only'}).text('Sending...')
                                ),
                                $('<h5>').text('Sending email link...'),
                                $('<p>').text('Please wait while we process your request.'),
                                $('<p>', {'class': 'text-muted small mt-3'}).html('<i class="fas fa-info-circle"></i> You can navigate away from this page. The link will be emailed to you.')
                            )
                        );
                        
                        // Replace buttons with a Close button
                        const closeBtn = $('<button>', {
                            'type': 'button',
                            'class': 'btn btn-secondary'
                        }).text('Close').on('click', function() {
                            $('#loadingModal').modal('hide');
                            setTimeout(function() {
                                $('#loadingModal').remove();
                                $('.modal-backdrop').remove();
                                $('body').removeClass('modal-open');
                            }, 300);
                        });
                        $('#loadingModal .modal-footer').html(closeBtn);
                        
                        // Submit the request
                        $.ajax({
                            url: '/batch-sample-download/',
                            type: 'POST',
                            data: formData,
                            processData: false,
                            contentType: false,
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            success: function(response, status, xhr) {
                                // Email was sent - update modal to show success
                                console.log('Email request successful');
                                $('#loadingModal .modal-body').html(
                                    $('<div>').append(
                                        $('<i>', {'class': 'fas fa-check-circle fa-3x text-success mb-3'}),
                                        $('<h5>').text('Email sent successfully!'),
                                        $('<p>').text('Check your email for the download link.'),
                                        $('<p>', {'class': 'text-muted small'}).text('The link will be valid for 7 days.')
                                    )
                                );
                                // Auto-close the modal after 90 seconds
                                setTimeout(function() {
                                    $('#loadingModal').modal('hide');
                                    setTimeout(function() {
                                        $('#loadingModal').remove();
                                        $('.modal-backdrop').remove();
                                        $('body').removeClass('modal-open');
                                    }, 300);
                                }, 90000); // 09 seconds = 1 minute
                            },
                            error: function(xhr, status, error) {
                                console.log('AJAX request ended with status:', status, 'error:', error);
                                
                                // Check if this is a timeout or connection issue (server still processing)
                                if (status === 'timeout' || status === 'error' || xhr.status === 0) {
                                    // Timeout or connection closed - server is still processing
                                    console.log('Connection timeout/closed - server is still processing');
                                    $('#loadingModal .modal-body').html(
                                        $('<div>').append(
                                            $('<i>', {'class': 'fas fa-hourglass-half fa-3x text-info mb-3'}),
                                            $('<h5>').text('Processing your request...'),
                                            $('<p>').text('Your download request is being processed on the server.'),
                                            $('<p>').text('You will receive an email with the download link when it\'s ready.'),
                                            $('<p>', {'class': 'text-muted small mt-3'}).html('<i class="fas fa-info-circle"></i> The link will be valid for 7 days.')
                                        )
                                    );
                                } else {
                                    // Actual error from server
                                    console.error('Email request failed with server error:', error);
                                    $('#loadingModal .modal-body').html(
                                        $('<div>').append(
                                            $('<i>', {'class': 'fas fa-exclamation-circle fa-3x text-danger mb-3'}),
                                            $('<h5>').text('Error sending email'),
                                            $('<p>').text('There was an error processing your download request. Please try again.')
                                        )
                                    );
                                }
                                
                                // Auto-close the modal after 90 seconds
                                setTimeout(function() {
                                    $('#loadingModal').modal('hide');
                                    setTimeout(function() {
                                        $('#loadingModal').remove();
                                        $('.modal-backdrop').remove();
                                        $('body').removeClass('modal-open');
                                    }, 300);
                                }, 90000); // 90 seconds
                            }
                        });
                    }
                };
                
                // Create close button for header
                const closeBtn = $('<button>', {
                    'type': 'button',
                    'class': 'close',
                    'aria-label': 'Close'
                }).append(
                    $('<span>', {'aria-hidden': 'true'}).html('&times;')
                ).on('click', cancelEmailModal);
                
                // Create Cancel button
                const cancelBtn = $('<button>', {
                    'type': 'button',
                    'class': 'btn btn-secondary'
                }).text('Cancel').on('click', cancelEmailModal);
                
                // Create Send Link button
                const sendBtn = $('<button>', {
                    'type': 'button',
                    'class': 'btn btn-primary'
                }).text('Send Link').on('click', sendEmailLink);
                
                console.log('Modal buttons created with handlers attached');
                
                loadingModal = $('<div>', {
                    'class': 'modal fade',
                    'id': 'loadingModal',
                    'tabindex': '-1',
                    'role': 'dialog',
                    'aria-hidden': 'true',
                    'data-backdrop': 'static',
                    'data-keyboard': 'false'
                }).append(
                    $('<div>', {'class': 'modal-dialog modal-dialog-centered'}).append(
                        $('<div>', {'class': 'modal-content'}).append(
                            $('<div>', {'class': 'modal-header'}).append(
                                $('<h5>', {'class': 'modal-title'}).text('Email Download Link'),
                                closeBtn
                            ),
                            $('<div>', {'class': 'modal-body text-center'}).append(
                                $('<i>', {'class': 'fas fa-envelope fa-3x text-primary mb-3'}),
                                $('<p>').html('You have selected <strong>' + samples.length + ' samples</strong>.'),
                                $('<p>').html('Due to the large number of samples, a download link will be emailed to:<br><strong>' + userEmail + '</strong>'),
                                $('<p>', {'class': 'text-muted small mt-3'}).text('The link will be valid for 7 days.')
                            ),
                            $('<div>', {'class': 'modal-footer'}).append(
                                cancelBtn,
                                sendBtn
                            )
                        )
                    )
                );
                
                // Store state flags
                loadingModal.data('formSubmitted', false);
                loadingModal.data('cancelled', false);
            } else {
                // Show standard loading message for immediate downloads
                loadingModal = $('<div>', {
                    'class': 'modal fade',
                    'id': 'loadingModal',
                    'tabindex': '-1',
                    'role': 'dialog',
                    'aria-hidden': 'true'
                }).append(
                    $('<div>', {'class': 'modal-dialog modal-dialog-centered'}).append(
                        $('<div>', {'class': 'modal-content'}).append(
                            $('<div>', {'class': 'modal-header'}).append(
                                $('<h5>', {'class': 'modal-title'}).text('Preparing Download'),
                                $('<button>', {
                                    'type': 'button',
                                    'class': 'close',
                                    'data-dismiss': 'modal',
                                    'aria-label': 'Close'
                                }).append(
                                    $('<span>', {'aria-hidden': 'true'}).html('&times;')
                                )
                            ),
                            $('<div>', {'class': 'modal-body text-center'}).append(
                                $('<div>', {'class': 'spinner-border text-primary mb-3', 'role': 'status'}).append(
                                    $('<span>', {'class': 'sr-only'}).text('Loading...')
                                ),
                                $('<h5>').text('Gathering samples, please wait.'),
                                $('<p>').text('This can take a few minutes for large downloads...')
                            ),
                            $('<div>', {'class': 'modal-footer'}).append(
                                $('<button>', {
                                    'type': 'button',
                                    'class': 'btn btn-secondary',
                                    'data-dismiss': 'modal'
                                }).text('Close')
                            )
                        )
                    )
                );
            }

            $('body').append(loadingModal);
            
            // Prepare form data for XHR submission
            const formData = new FormData();
            formData.append('csrfmiddlewaretoken', $('[name=csrfmiddlewaretoken]').val());
            
            // Add selected samples
            samples.forEach(function(sample) {
                formData.append('samples', sample);
            });

            // Add flag for private samples
            formData.append('is_private', isPrivate ? '1' : '0');

            // Add emailResults flag if sample count > 100
            if (shouldEmailResults) {
                formData.append('emailResults', 'true');
            }
            
            // Handle submission differently for email vs immediate downloads
            if (shouldEmailResults) {
                // For email downloads: show modal and wait for user to click Send Link or Cancel
                // The submission is handled by the sendEmailLink function attached to the button
                
                // Show the modal - backdrop is static to prevent accidental dismissal
                console.log('Showing email confirmation modal');
                $('#loadingModal').modal('show');
            } else {
                // For immediate downloads: use XHR with blob response
                $('#loadingModal').modal('show');
                
                $.ajax({
                    url: '/batch-sample-download/',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    xhrFields: {
                        responseType: 'blob'
                    },
                    success: function(blob, status, xhr) {
                        console.log('Download ready, triggering file download');
                        
                        // Get filename from Content-Disposition header if available
                        const disposition = xhr.getResponseHeader('Content-Disposition');
                        let filename = 'batch_samples.zip';
                        if (disposition && disposition.indexOf('filename=') !== -1) {
                            const filenameMatch = disposition.match(/filename="?(.+)"?/);
                            if (filenameMatch && filenameMatch[1]) {
                                filename = filenameMatch[1];
                            }
                        }
                        
                        // Create a download link and trigger it
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = url;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                        
                        // Keep modal visible for exactly 6 seconds
                        setTimeout(function() {
                            $('#loadingModal').modal('hide');
                            // Clean up the modal from DOM after it's hidden
                            setTimeout(function() {
                                $('#loadingModal').remove();
                                $('.modal-backdrop').remove();
                                $('body').removeClass('modal-open');
                            }, 300); // Wait for Bootstrap's fade animation
                        }, 6000); // Keep modal visible for 6 seconds so user sees it
                    },
                    error: function(xhr, status, error) {
                        console.error('Download request failed:', error);
                        // Close modal immediately on error
                        $('#loadingModal').modal('hide');
                        setTimeout(function() {
                            $('#loadingModal').remove();
                            $('.modal-backdrop').remove();
                            $('body').removeClass('modal-open');
                            alert('Error processing download request. Please try again.');
                        }, 300);
                    }
                });
            }
        }

        // Public samples - Download Selected button
        $('#download-public-selected').on('click', function() {
            // Convert Map keys to array for download function
            const samplesArray = Array.from(publicSelectedSamples.keys());
            downloadSelectedSamples(samplesArray, false);
        });

        // Private samples - Download Selected button
        $('#download-private-selected').on('click', function() {
            // Convert Map keys to array for download function
            const samplesArray = Array.from(privateSelectedSamples.keys());
            downloadSelectedSamples(samplesArray, true);
        });
    });
</script>
{% endblock %}

{% block main %}
<h2 class="mt-4">Search Query Information </h2>


<div class="search-container">
    <!-- Embedded Search Box from search.html -->
    <div class="search-box">
        {% include 'includes/searchbox.html' %}

        <!-- Public Project Filters -->
        <div class="project-filters" id="public-project-filters">
            <h5>Filter by Project</h5>
            {% if public_project_filters %}
            <div class="filter-list">
                {% for project in public_project_filters %}
                <div class="filter-item">
                    <input type="checkbox" 
                           class="project-filter-checkbox" 
                           id="public-filter-{{ project.id }}"
                           data-project-id="{{ project.id }}"
                           checked>
                    <label for="public-filter-{{ project.id }}">
                        {{ project.name }} <span class="filter-count">({{ project.count }})</span>
                    </label>
                </div>
                {% endfor %}
            </div>
            <div class="filter-actions">
                <button class="btn btn-sm btn-outline-primary select-all-filters">Select All</button>
                <button class="btn btn-sm btn-outline-secondary clear-all-filters">Clear All</button>
            </div>
            {% else %}
            <p class="no-filters">No projects in results</p>
            {% endif %}
        </div>

        <!-- Private Project Filters (shown when viewing private samples tab) -->
        {% if user.is_authenticated and private_project_filters %}
        <div class="project-filters" id="private-project-filters" style="display: none;">
            <h5>Filter by Project</h5>
            <div class="filter-list">
                {% for project in private_project_filters %}
                <div class="filter-item">
                    <input type="checkbox" 
                           class="project-filter-checkbox private-filter" 
                           id="private-filter-{{ project.id }}"
                           data-project-id="{{ project.id }}"
                           checked>
                    <label for="private-filter-{{ project.id }}">
                        {{ project.name }} <span class="filter-count">({{ project.count }})</span>
                    </label>
                </div>
                {% endfor %}
            </div>
            <div class="filter-actions">
                <button class="btn btn-sm btn-outline-primary select-all-filters private-filters">Select All</button>
                <button class="btn btn-sm btn-outline-secondary clear-all-filters private-filters">Clear All</button>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Results (Right) -->
    <div class="results-container" >
        <ul class="nav nav-tabs">
            <li class="nav-item">
                <a class="nav-link" href="#projects-tab" data-toggle="tab">
                    Projects <span class="badge badge-primary">{{ public_projects_count }}</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="#samples-tab" data-toggle="tab">
                    Samples <span class="badge badge-primary">{{ public_samples_count }} </span>
                </a>
            </li>
            {% if user.is_authenticated %}
            <li class="nav-item">
                <a class="nav-link" href="#private-projects-tab" data-toggle="tab">
                    Private Projects <span class="badge badge-primary">{{ private_projects_count }}</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#private-samples-tab" data-toggle="tab">
                    Private Samples <span class="badge badge-primary">{{ private_samples_count }}</span>
                </a>
            </li>
            {% endif %}
        </ul>

        <div class="tab-content" style="padding-top: 20px; overflow-x: auto;">
            <!-- Public Projects Tab -->
            <div class="tab-pane" id="projects-tab">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Description</th>
                            <th>Last Updated</th>
                            <th>Project Members</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for project in public_projects %}
                        <tr>
                            <td><a target="_blank" href="{% url 'project_page' project_name=project.linkid %}">{{ project.project_name }}</a></td>
                            <td>{{ project.description }}</td>
                            <td>{{ project.date }}</td>
                            <td>{% for person in project.project_members %}
                                {{ person }}<br>
                            {% endfor %}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Public Samples Tab -->
            <div class="tab-pane active" id="samples-tab">
                <!-- Batch download controls -->
                <div class="batch-controls">
                    <button id="select-all-public" class="btn btn-sm btn-outline-secondary">Select All</button>
                    <button id="deselect-all-public" class="btn btn-sm btn-outline-secondary">Deselect All</button>
                    <button id="download-public-selected" class="btn btn-sm btn-primary" disabled>Download Selected Samples</button>
                    <span id="public-selected-count" class="selected-count">0 samples selected</span>
                </div>

                <table class="table" id="public-samples-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="public-select-all-checkbox"></th>
                            <th>Project Name</th>
                            <th>Sample Name</th>
                            <th>Feature ID</th>
                            <th>Genes</th>
                            <th>Classification</th>
                            <th>Sample Type</th>
                            <th>Cancer Type</th>
                            <th>Tissue of Origin</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for sample in public_sample_data %}
                        <tr>
                            <td>
                                <input type="checkbox" class="sample-checkbox public-sample-checkbox"
                                       data-project-id="{{ sample.project_linkid }}"
                                       data-sample-name="{{ sample.Sample_name }}">
                            </td>
                            <td><a target="_blank" href="{% url 'project_page' project_name=sample.project_linkid %}">{{ sample.project_name }}</a></td>
                            <td><a target="_blank" href="/project/{{sample.project_linkid}}/sample/{{sample.Sample_name}}">{{ sample.Sample_name }}</a></td>
                            <td><code>{{ sample.Feature_ID }}</code></td>
                            <td>{{ sample.All_genes|join:", " }}</td>
                            <td>{{ sample.Classification}}</td>
                            <td>{{ sample.Sample_type}}</td>
                            <td>{{ sample.Cancer_type}}</td>
                            <td>{{ sample.Tissue_of_origin}}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {% if user.is_authenticated %}
            <!-- Private Projects Tab -->
            <div class="tab-pane" id="private-projects-tab">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Description</th>
                            <th>Last Updated</th>
                            <th>Project Members</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for project in private_projects %}
                        <tr>
                            <td><a target="_blank" href="{% url 'project_page' project_name=project.linkid %}">{{ project.project_name }}</a></td>
                            <td>{{ project.description }}</td>
                            <td>{{ project.date }}</td>
                            <td>{% for person in project.project_members %}
                                {{ person }}<br>
                            {% endfor %}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Private Samples Tab -->
            <div class="tab-pane" id="private-samples-tab">
                <!-- Batch download controls -->
                <div class="batch-controls">
                    <button id="select-all-private" class="btn btn-sm btn-outline-secondary">Select All</button>
                    <button id="deselect-all-private" class="btn btn-sm btn-outline-secondary">Deselect All</button>
                    <button id="download-private-selected" class="btn btn-sm btn-primary" disabled>Download Selected Samples</button>
                    <span id="private-selected-count" class="selected-count">0 samples selected</span>
                </div>

                <table class="table" id="private-samples-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="private-select-all-checkbox"></th>
                            <th>Project Name</th>
                            <th>Sample Name</th>
                            <th>Feature ID</th>
                            <th>Genes</th>
                            <th>Classification</th>
                            <th>Sample Type</th>
                            <th>Cancer Type</th>
                            <th>Tissue of Origin</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for sample in private_sample_data %}
                        <tr>
                            <td>
                                <input type="checkbox" class="sample-checkbox private-sample-checkbox"
                                       data-project-id="{{ sample.project_linkid }}"
                                       data-sample-name="{{ sample.Sample_name }}">
                            </td>
                            <td><a target="_blank" href="{% url 'project_page' project_name=sample.project_linkid %}">{{ sample.project_name }}</a></td>
                            <td><a target="_blank" href="/project/{{sample.project_linkid}}/sample/{{sample.Sample_name}}">{{ sample.Sample_name }}</a></td>
                            <td><code>{{ sample.Feature_ID }}</code></td>
                            <td>{{ sample.All_genes|join:", " }}</td>
                            <td>{{ sample.Classification}}</td>
                            <td>{{ sample.Sample_type}}</td>
                            <td>{{ sample.Cancer_type}}</td>
                            <td>{{ sample.Tissue_of_origin}}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% csrf_token %}
{% endblock %}