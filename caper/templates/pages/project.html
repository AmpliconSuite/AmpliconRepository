{% extends 'base.html' %}

{% load custom_filters %}
{% load static %}

{% block extra_js %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
    .wait-cursor,
    .wait-cursor * {
        cursor: wait !important;
    }
</style>
<script>
    $(document).ready( function () {
      // Flag to track if we've already auto-generated a key for this page load
      let keyAutoGenerated = false;
      
      // when the modal is shown, generate a key if there is not already one if the key
      // dialog is opened, so there is always a value available
      $('#projectInfoModal').on('shown.bs.modal', function() {
        // Check if the privateKey field is empty and we haven't auto-generated a key yet
        if ($("#privateKey").val() === "" && !keyAutoGenerated) {
          // Call the regenerateProjectKey function
          regenerateProjectKey();
          // Set the flag to true to prevent regenerating on subsequent opens
          keyAutoGenerated = true;
        }
      });
    
    
        var table = $('#myTable1').DataTable();

        // Update filtered count display
        function updateFilteredCount() {
            var info = table.page.info();
            var filteredCount = info.recordsDisplay;
            var totalCount = info.recordsTotal;
            
            if (filteredCount === totalCount) {
                $('#filtered-count').text('(' + totalCount + ' samples)');
            } else {
                $('#filtered-count').text('(' + filteredCount + ' of ' + totalCount + ' samples shown)');
            }
        }

        // Update count on table draw
        table.on('draw', function() {
            updateFilteredCount();
        });

        // Initial count update
        updateFilteredCount();

        // Handle download filtered samples button click
        $('#download-filtered-samples').on('click', function() {
            var filteredSamples = [];
            var projectId = '{{ project.linkid }}';
            
            // Get all filtered rows
            table.rows({ search: 'applied' }).every(function() {
                var data = this.data();
                // Extract sample name from the first column (which contains an <a> tag)
                var sampleName = $(data[0]).text();
                // Format as projectId:sampleName to match backend expectations
                filteredSamples.push(projectId + ':' + sampleName);
            });

            if (filteredSamples.length === 0) {
                alert('No samples to download.');
                return;
            }

            // Check if user is logged in
            if (!{% if user.is_authenticated %}true{% else %}false{% endif %}) {
                alert('You must be logged in to batch download samples. Please log in and try again.');
                window.location.href = '/accounts/login/?next=' + encodeURIComponent(window.location.pathname);
                return;
            }

            // Check if sample count > 100 to determine if we should email results
            var shouldEmailResults = filteredSamples.length > 100;
            var userEmail = "{{ user.email|default:user.username }}";

            // Show loading message or email notification based on sample count
            var loadingModal;
            if (shouldEmailResults) {
                // Show email notification message for large downloads
                // Track if form has been submitted or cancelled
                var formSubmitted = false;
                var cancelled = false;
                
                // Function to handle cancel
                var cancelEmailModal = function(e) {
                    console.log('Cancel button clicked!', e);
                    if (!formSubmitted && !cancelled) {
                        console.log('Cancelling download request');
                        cancelled = true;
                        $('#loadingModal').modal('hide');
                        // Clean up after animation
                        setTimeout(function() {
                            $('#loadingModal').remove();
                            $('.modal-backdrop').remove();
                            $('body').removeClass('modal-open');
                        }, 300);
                    }
                };
                
                // Function to handle send confirmation
                var sendEmailLink = function(e) {
                    console.log('Send Link button clicked!', e);
                    if (!formSubmitted && !cancelled) {
                        console.log('User confirmed - sending email link');
                        formSubmitted = true;
                        
                        // Update modal to show "sending" state
                        $('#loadingModal .modal-body').html(
                            $('<div>').append(
                                $('<div>', {'class': 'spinner-border text-primary mb-3', 'role': 'status'}).append(
                                    $('<span>', {'class': 'sr-only'}).text('Sending...')
                                ),
                                $('<h5>').text('Sending email link...'),
                                $('<p>').text('Please wait while we process your request.'),
                                $('<p>', {'class': 'text-muted small mt-3'}).html('<i class="fas fa-info-circle"></i> You can navigate away from this page. The link will be emailed to you.')
                            )
                        );
                        
                        // Replace buttons with a Close button
                        var closeBtn = $('<button>', {
                            'type': 'button',
                            'class': 'btn btn-secondary'
                        }).text('Close').on('click', function() {
                            $('#loadingModal').modal('hide');
                            setTimeout(function() {
                                $('#loadingModal').remove();
                                $('.modal-backdrop').remove();
                                $('body').removeClass('modal-open');
                            }, 300);
                        });
                        $('#loadingModal .modal-footer').html(closeBtn);
                        
                        // Submit the form
                        $('body').append(form);
                        form.submit();
                        // Note: For form submission, page will redirect on success
                        // The modal will remain visible until page reloads
                    }
                };
                
                // Create close button for header
                var closeBtn = $('<button>', {
                    'type': 'button',
                    'class': 'close',
                    'aria-label': 'Close'
                }).append(
                    $('<span>', {'aria-hidden': 'true'}).html('&times;')
                ).on('click', cancelEmailModal);
                
                // Create Cancel button
                var cancelBtn = $('<button>', {
                    'type': 'button',
                    'class': 'btn btn-secondary'
                }).text('Cancel').on('click', cancelEmailModal);
                
                // Create Send Link button
                var sendBtn = $('<button>', {
                    'type': 'button',
                    'class': 'btn btn-primary'
                }).text('Send Link').on('click', sendEmailLink);
                
                console.log('Modal buttons created with handlers attached');
                
                loadingModal = $('<div>', {
                    'class': 'modal fade',
                    'id': 'loadingModal',
                    'tabindex': '-1',
                    'role': 'dialog',
                    'aria-hidden': 'true',
                    'data-backdrop': 'static',
                    'data-keyboard': 'false'
                }).append(
                    $('<div>', {'class': 'modal-dialog modal-dialog-centered'}).append(
                        $('<div>', {'class': 'modal-content'}).append(
                            $('<div>', {'class': 'modal-header'}).append(
                                $('<h5>', {'class': 'modal-title'}).text('Email Download Link'),
                                closeBtn
                            ),
                            $('<div>', {'class': 'modal-body text-center'}).append(
                                $('<i>', {'class': 'fas fa-envelope fa-3x text-primary mb-3'}),
                                $('<p>').html('You have selected <strong>' + filteredSamples.length + ' samples</strong>.'),
                                $('<p>').html('Due to the large number of samples, a download link will be emailed to:<br><strong>' + userEmail + '</strong>'),
                                $('<p>', {'class': 'text-muted small mt-3'}).text('The link will be valid for 7 days.')
                            ),
                            $('<div>', {'class': 'modal-footer'}).append(
                                cancelBtn,
                                sendBtn
                            )
                        )
                    )
                );
                
                // Store state flags
                loadingModal.data('formSubmitted', false);
                loadingModal.data('cancelled', false);
            } else {
                // Show standard loading message for immediate downloads
                loadingModal = $('<div>', {
                    'class': 'modal fade',
                    'id': 'loadingModal',
                    'tabindex': '-1',
                    'role': 'dialog',
                    'aria-hidden': 'true'
                }).append(
                    $('<div>', {'class': 'modal-dialog modal-dialog-centered'}).append(
                        $('<div>', {'class': 'modal-content'}).append(
                            $('<div>', {'class': 'modal-header'}).append(
                                $('<h5>', {'class': 'modal-title'}).text('Preparing Download'),
                                $('<button>', {
                                    'type': 'button',
                                    'class': 'close',
                                    'data-dismiss': 'modal',
                                    'aria-label': 'Close'
                                }).append(
                                    $('<span>', {'aria-hidden': 'true'}).html('&times;')
                                )
                            ),
                            $('<div>', {'class': 'modal-body text-center'}).append(
                                $('<div>', {'class': 'spinner-border text-primary mb-3', 'role': 'status'}).append(
                                    $('<span>', {'class': 'sr-only'}).text('Loading...')
                                ),
                                $('<h5>').text('Gathering samples, please wait.'),
                                $('<p>').text('This can take a few minutes for large downloads...')
                            ),
                            $('<div>', {'class': 'modal-footer'}).append(
                                $('<button>', {
                                    'type': 'button',
                                    'class': 'btn btn-secondary',
                                    'data-dismiss': 'modal'
                                }).text('Close')
                            )
                        )
                    )
                );
            }

            $('body').append(loadingModal);

            // Create a form for submission
            var form = $('<form>', {
                'method': 'POST',
                'action': '/batch-sample-download/',
                'style': 'display: none'
            });

            // Add CSRF token
            form.append($('<input>', {
                'type': 'hidden',
                'name': 'csrfmiddlewaretoken',
                'value': getCookie('csrftoken')
            }));

            // Add filtered samples
            filteredSamples.forEach(function(sample) {
                form.append($('<input>', {
                    'type': 'hidden',
                    'name': 'samples',
                    'value': sample
                }));
            });

            // Add flag for private samples
            form.append($('<input>', {
                'type': 'hidden',
                'name': 'is_private',
                'value': {% if project.private %}'1'{% else %}'0'{% endif %}
            }));

            // Add emailResults flag if sample count > 100
            if (shouldEmailResults) {
                form.append($('<input>', {
                    'type': 'hidden',
                    'name': 'emailResults',
                    'value': 'true'
                }));
            }
            
            // Handle form submission differently for email vs immediate downloads
            if (shouldEmailResults) {
                // For email downloads: show modal and wait for user to click Send Link or Cancel
                // The submission is handled by the sendEmailLink function attached to the button
                
                // Show the modal - backdrop is static to prevent accidental dismissal
                console.log('Showing email confirmation modal');
                $('#loadingModal').modal('show');
            } else {
                // For immediate downloads: show modal and submit right away
                $('#loadingModal').modal('show');
                
                $('body').append(form);
                form.submit();
                
                // Give the download a moment to start, then close the modal
                setTimeout(function() {
                    $('#loadingModal').modal('hide');
                    // Clean up the modal from DOM after it's hidden
                    setTimeout(function() {
                        $('#loadingModal').remove();
                        $('.modal-backdrop').remove();
                        $('body').removeClass('modal-open');
                    }, 300); // Wait for Bootstrap's fade animation
                }, 10000); // Keep modal visible for 10 seconds so user sees it
            }
        });
    } );
    $(document).ready( function () {
        $('#myTable2').DataTable({
        }
        );


        message_to_user = "{{ message }}";
        if (message_to_user.length > 0){
            // changed alert to console.log. as long projects will now go to the loading page
            console.log(message_to_user);
        } else {
            //alert("Nothing to say")
        }

        // Hide plotly_plots div if there's only one sample
        var sampleCount = parseInt("{{ sample_data|length|default:0 }}".replace(/,/g, ''));
        if (sampleCount === 1) {
            $('#plotly_plots').hide();
        } else {
            $('#plotly_plots').show();
        }

    } );
    function show_div() {
        var x = document.getElementById("prev_versions_table");
        if (x.style.display === "none") {
          x.style.display = "block";
          x.scrollIntoView();

        } else {
          x.style.display = "none";
        }
      }

</script>

<script>
    // Function to format the date string
    function formatDate(dateString) {
        // Parse the date string into a Date object (assuming it's in UTC)
        const utcDate = new Date(dateString);
        //Convert the UTC date to the local timezone
        const localDate = new Date(utcDate.getTime() - utcDate.getTimezoneOffset() * 60000);
        {#const localDate = utcDate#}
        // Format the local date using the desired format
        const formattedDate = localDate.toLocaleString('en-US', {
            month: 'long',
            day: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: true,
            timeZoneName: 'short'
        });
        return formattedDate;
    }

    // Function to format all date elements in the table
    function formatDates() {
        const dateElements = document.querySelectorAll('.date');
        dateElements.forEach(element => {
            const originalDate = element.textContent.trim();
            const formattedDate = formatDate(originalDate);
            element.textContent = formattedDate;
        });
    }

    // Call the formatDates function when the page is loaded
    document.addEventListener('DOMContentLoaded', formatDates);

    // Description truncation and toggle
    document.addEventListener('DOMContentLoaded', function() {
        const fullDescription = "{{ project.description|escapejs }}";
        const descriptionContainer = document.getElementById('description-container');
        const descriptionShort = document.getElementById('description-short');
        const descriptionFull = document.getElementById('description-full');
        const descriptionToggle = document.getElementById('description-toggle');
        
        if (!fullDescription || fullDescription.trim() === '') {
            return;
        }
        
        const maxLength = 70;
        
        // If description is 70 characters or less, display it normally
        if (fullDescription.length <= maxLength) {
            descriptionShort.textContent = fullDescription;
            descriptionFull.style.display = 'none';
            descriptionToggle.style.display = 'none';
        } else {
            // Description is longer than 70 characters, truncate at word boundary
            let truncated = fullDescription.substring(0, maxLength);
            
            // Find the last space before position 70 to avoid cutting words
            const lastSpace = truncated.lastIndexOf(' ');
            if (lastSpace > 0) {
                truncated = truncated.substring(0, lastSpace);
            }
            
            // Set the truncated text
            descriptionShort.textContent = truncated + '... ';
            descriptionToggle.textContent = '(more)';
            descriptionToggle.style.display = 'inline';
            descriptionFull.style.display = 'none';
        }
    });
    
    function toggleDescription() {
        const descriptionShort = document.getElementById('description-short');
        const descriptionFull = document.getElementById('description-full');
        const descriptionToggle = document.getElementById('description-toggle');
        
        if (descriptionFull.style.display === 'none') {
            // Expand
            descriptionShort.style.display = 'none';
            descriptionFull.style.display = 'inline';
            descriptionToggle.textContent = ' (less)';
        } else {
            // Collapse
            descriptionShort.style.display = 'inline';
            descriptionFull.style.display = 'none';
            descriptionToggle.textContent = '(more)';
        }
    }

    function downloadSummaryTable() {
        // Add wait cursor class to body
        document.body.classList.add('wait-cursor');
        
        // Use fetch API to download the file
        fetch("/project/{{ project.linkid }}/download_summary?format=csv")
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.blob();
            })
            .then(blob => {
                // Create a download link and trigger it
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = '{{ project.project_name|default:"project" }}_summary.csv';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                // Remove wait cursor
                document.body.classList.remove('wait-cursor');
            })
            .catch(error => {
                console.error('Download failed:', error);
                alert('Failed to download summary table. Please try again.');
                document.body.classList.remove('wait-cursor');
            });
    }

    function downloadAndReload() {
        // Add wait cursor class to body
        document.body.classList.add('wait-cursor');
        
        // Create an invisible anchor element
        const a = document.createElement('a');
        // Set the href to the file URL
        a.href = "/project/{{ project.linkid }}/download";
        // Set the download attribute to the filename
        // Append the anchor to the body
        document.body.appendChild(a);
        // Trigger the download by simulating a click
        a.click();
        // Remove the anchor from the body
        document.body.removeChild(a);
        
        // Remove wait cursor after delay
        setTimeout(function() {
            document.body.classList.remove('wait-cursor');
        }, 6000);
        
        // Reload the page after a short delay to ensure the download starts

        //updating the number, this number will be increased automatically in database
        var numberContainer = $('#downloads');
        // Get the current number, parse it as an integer, and increment it
        var currentNumber = parseInt(numberContainer.text(), 10);
        var newNumber = currentNumber + 1;
        // Update the element with the new number
        numberContainer.text(newNumber);
    }


    function copyToClipboard() {
        // Get the anchor element with the URL
        var copyText = document.getElementById("aliaslink");

        // Create a range and select the text
        var range = document.createRange();
        range.selectNode(copyText);

        // Get the selection object and add the range to it
        var selection = window.getSelection();
        selection.removeAllRanges(); // Clear any existing selections
        selection.addRange(range);

        // Copy the selected text to the clipboard
        try {
            var successful = document.execCommand('copy');
            var message = successful ? 'Copied to clipboard!' : 'Unable to copy.';
            document.getElementById("message").innerHTML = message;
            // Remove the message after 5 seconds (5000 milliseconds)
            setTimeout(function() {
                document.getElementById("message").innerHTML = '';
            }, 3000);


        } catch (err) {
            console.error('Failed to copy:', err);
        }

        // Clear the selection for better user experience
        selection.removeAllRanges();
    }




</script>

{% endblock %}

{% block meta_title %} {{ project.project_name }}
{% endblock %}

{% block main %}


<div class="container">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="/">Home</a></li>
          <li class="breadcrumb-item active" aria-current="page">{{ project.project_name }}</li>
        </ol>
    </nav>
</div>

<div class="container row" style="margin:auto; padding:0px; padding-top: 20px;">
    <div class="col-md-9">
        <h2>Project: <span style="font-weight: 200">{{ project.project_name }}</span>

        {% if not viewing_old_project %}
            {% if project.current_user_may_edit  %}
            <a href="{% url 'edit_project_page' project_name=project.linkid %}" data-toggle="tooltip" title="Edit Project"><i class="fas fa-edit" style="font-size: 24px"></i></a>
             <a href="javascript:void(0);" onclick="$('#projectInfoModal').modal('show');" data-toggle="tooltip" title="Upload Project"><i class="fas fa-key" style="font-size: 24px; margin-left: 10px;"></i></a>
           <div class="modal fade" id="projectInfoModal" tabindex="-1" role="dialog" aria-labelledby="projectInfoModalLabel" aria-hidden="true">
             <div class="modal-dialog" role="document" style="max-width: 550px;">
               <div class="modal-content">
                 <div class="modal-header">
                   <h5 class="modal-title" id="projectInfoModalLabel"><i class="fas fa-key" style="font-size: 24px; margin-left: 10px;"></i> Project key for AmpliconSuite</h5>
                   <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="$('#projectInfoModal').modal('hide');">
                     <span aria-hidden="true">&times;</span>
                   </button>
                 </div>
                 <div class="modal-body">
                   <div class="form-group row mb-2 col-form-label-sm">When running AmpliconSuite you can provide these values to have samples automatically added to this project.</div>
                   <div class="form-group row mb-2">
                     <label for="projectUuid" class="col-sm-3 col-form-label col-form-label-sm">Project ID:</label>
                     <div class="col-sm-9">
                       <input type="text" class="form-control" id="projectUuid" value="{{ project.linkid }}" readonly>
                     </div>
                   </div>
                   <div class="form-group row mb-2">
                     <label for="privateKey" class="col-sm-3 col-form-label col-form-label-sm">Project Key:</label>
                     <div class="col-sm-9">
                       <input type="text" class="form-control" id="privateKey" value="{{ project.privateKey|default:'' }}" readonly>
                     </div>
                   </div>
                 </div>
                 <div class="modal-footer">
                   <button type="button" class="btn btn-primary" onclick="regenerateProjectKey()">Regenerate Key</button>
                   <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="$('#projectInfoModal').modal('hide');">Close</button>
                 </div>
               </div>
             </div>
           </div>
           
           <script>
           function regenerateProjectKey() {
             $.ajax({
               url: "/project/{{ project.linkid }}/regenerate_project_key",
               type: "POST",
               headers: {
                 "X-CSRFToken": getCookie("csrftoken"),
                   'Content-Type': 'application/json'
               },
               success: function(response) {
                 if (response.key) {
                   $("#privateKey").val(response.key);
                 } else {
                   alert("Failed to regenerate key: " + response.error);
                 }
               },
               error: function(xhr, status, error) {
                 alert("Error: " + error);
               }
             });
           }
           
           // Helper function to get CSRF token from cookies
           function getCookie(name) {
             let cookieValue = null;
             if (document.cookie && document.cookie !== '') {
               const cookies = document.cookie.split(';');
               for (let i = 0; i < cookies.length; i++) {
                 const cookie = cookies[i].trim();
                 if (cookie.substring(0, name.length + 1) === (name + '=')) {
                   cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                   break;
                 }
               }
             }
             return cookieValue;
           }
           </script>
        {%  endif %}</h2>
        {% endif %}

        <br>
        <h5>Description: <span id="description-container" style="font-weight: 200">
            <span id="description-short"></span>
            <span id="description-full" style="display: none;">{{ project.description }}</span>
            <a href="javascript:void(0);" id="description-toggle" style="font-style: italic; display: none;" onclick="toggleDescription()"></a>
        </span></h5>
        <h5>Publication link: <span style="font-weight: 200">{{ project.publication_link|escape|replace_urls|safe }}</span></h5>
        {% if not is_empty_project %}
        <h5>Reference build: <span style="font-weight: 200">{{ reference_genome }}</span></h5>
        {% endif %}
        {% if project.alias_name %}
            <h5>Project Link: <a id='aliaslink' href="">ampliconrepository.org/project/{{project.alias_name}}  </a><i class="fas fa-link chain-icon" style = 'cursor:pointer;'onclick="copyToClipboard()"></i></h5>
            <p id="message"></p>
        {% endif %}
            
        
    </div>

    {% if not is_empty_project %}
    <div class="col-md-3" style="text-align:left;">
        <a class="btn btn-primary" style="color: white; margin-bottom: 12px; width: 205px; display: block;"
           onclick="downloadAndReload();">
            <i class="fas fa-download"></i> Download Project
        </a>

        <a class="btn btn-primary" style="color: white; margin-bottom: 12px; cursor: pointer; width: 205px; display: block;"
           onclick="downloadSummaryTable();">
            <i class="fas fa-download"></i> Download Summary
        </a>
        {% if  project.private %}<div style="">Visibility: <b>Private</b></div>{% endif %}
        <div id="project-members-accordion" style="margin-bottom: 15px; ">
            <style>
                .members-toggle:not(.expanded)::before,
                .members-toggle-empty:not(.expanded)::before {
                    content: "";
                    display: inline-block;
                    border-style: solid;
                    border-width: 0.4em 0 0.4em 0.4em;
                    border-color: transparent transparent transparent #000;
                    margin-right: 0.5em;
                    transform: rotate(0deg);
                    vertical-align: middle;
                }

                .members-toggle.expanded::before,
                .members-toggle-empty.expanded::before {
                    content: "";
                    display: inline-block;
                    border-style: solid;
                    border-width: 0.4em 0 0.4em 0.4em;
                    border-color: transparent transparent transparent #000;
                    margin-right: 0.5em;
                    transform: rotate(90deg);
                    vertical-align: middle;
                }
            </style>
            <div style="display: inline-block; text-align: left;">
                <span class="members-toggle" onclick="toggleMembers()" style="cursor: pointer; font-weight: bold; user-select: none;">Project Members</span>
            </div>
            <div id="members-list" style="display: none; margin-top: 8px; text-align: left; width: 205px;">
                {{ project.project_members|join:", " }}
            </div>
        </div>
        <script>
        function toggleMembers() {
            var list = document.getElementById('members-list');
            var toggle = document.querySelector('.members-toggle');
            
            if (list.style.display === 'none') {
                list.style.display = 'block';
                toggle.classList.add('expanded');
            } else {
                list.style.display = 'none';
                toggle.classList.remove('expanded');
            }
        }
        </script>

       
        {% if user.is_authenticated and not is_project_member %}
        <div style="margin-top: 10px; border-radius: 5px;">
            <div style="display: inline-block; text-align: left;">
            <label style="cursor: pointer; user-select: none;">
                <input type="checkbox" id="subscription-checkbox" style="margin-right: 5px;">
                <span id="subscription-label">Subscribe to project updates</span>
            </label>
            <div id="subscription-message" style="margin-top: 5px; "></div>
            </div>
        </div>
        <script>
        $(document).ready(function() {
            // Check current subscription status on page load
            checkSubscriptionStatus();
            
            // Handle checkbox change
            $('#subscription-checkbox').on('change', function() {
                toggleSubscription();
            });
        });
        
        function checkSubscriptionStatus() {
            // Check if user is subscribed
            var subscribers = {{ project.subscribers|default:"[]"|safe }};
            var userEmail = "{{ user.email|default:user.username }}";
            var isSubscribed = subscribers.includes(userEmail);
            
            $('#subscription-checkbox').prop('checked', isSubscribed);
            updateSubscriptionLabel(isSubscribed);
        }
        
        function toggleSubscription() {
            $.ajax({
                url: "/project/{{ project.linkid }}/toggle_subscription",
                type: "POST",
                headers: {
                    "X-CSRFToken": getCookie("csrftoken"),
                    'Content-Type': 'application/json'
                },
                success: function(response) {
                    updateSubscriptionLabel(response.is_subscribed);
                    showSubscriptionMessage(response.message, 'success');
                },
                error: function(xhr, status, error) {
                    var errorMsg = "An error occurred";
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMsg = xhr.responseJSON.error;
                    }
                    showSubscriptionMessage(errorMsg, 'error');
                    // Revert checkbox to previous state
                    $('#subscription-checkbox').prop('checked', !$('#subscription-checkbox').prop('checked'));
                }
            });
        }
        
        function updateSubscriptionLabel(isSubscribed) {
            if (isSubscribed) {
                $('#subscription-label').text('Subscribed to project updates');
            } else {
                $('#subscription-label').text('Subscribe to project updates');
            }
        }
        
        function showSubscriptionMessage(message, type) {
            var messageDiv = $('#subscription-message');
            var color = type === 'success' ? '#28a745' : '#dc3545';
            messageDiv.html('<span style="color: ' + color + ';">' + message + '</span>');
            
            // Clear message after 3 seconds
            setTimeout(function() {
                messageDiv.html('');
            }, 3000);
        }
        </script>
        {% endif %}
          <div id="project_statistics" style="text-align:left;"><div style="display: inline-block; text-align: left;">Views: {{ views }} | Downloads: <span id='downloads'>{{downloads}}</span></div></div>
       
    </div>
    
    <div id="plotly_plots" style="margin:auto; border: 0.5px solid grey; padding: 0px; display:none;">
        <span style="display:inline-block">{{ stackedbar_graph|safe }}
        {% block plotly_js %}
        <script type="text/javascript">
        var plot_element = document.getElementById("project_bar_plotly_div");
        plot_element.on('plotly_click', function(data){{
            var sname = data['points'][0]['customdata'][0];
            var url_no_message = window.location.href.split('/message')[0];
            var link = url_no_message + '/sample/' + sname;
{#            var link = window.location.href + '/sample/' + sname;#}
{#            console.log(link);#}
            window.open(link, "_blank");
            }})

        </script>
        {% endblock %}
        </span>
        <span style="display:inline-block">{{ piechart|safe }}</span>
    </div>
    {% else %}
        <div class="col-md-3">
        {% if  project.private %}Visibility: <b>Private</b>{% endif %}
        <div id="project-members-accordion-empty" style="margin-bottom: 15px;">
            <div>
                <span class="members-toggle-empty" onclick="toggleMembersEmpty()" style="cursor: pointer; font-weight: bold; user-select: none;">Project Members</span>
            </div>
            <div id="members-list-empty" style="display: none; margin-top: 8px;">
                {{ project.project_members|join:", " }}
            </div>
        </div>
        <script>
        function toggleMembersEmpty() {
            var list = document.getElementById('members-list-empty');
            var toggle = document.querySelector('.members-toggle-empty');
            
            if (list.style.display === 'none') {
                list.style.display = 'block';
                toggle.classList.add('expanded');
            } else {
                list.style.display = 'none';
                toggle.classList.remove('expanded');
            }
        }
        </script>

        </div>
        <div class="col-md-12 text-center" style="margin-top: 50px; margin-bottom: 50px;">
            <h4 style="color: #666;">No samples in project</h4>
        </div>
    {% endif %}
</div>
<br>
<div class="container">
  {% if not is_empty_project %}  
<div style="margin-bottom: 15px;">
    <button id="download-filtered-samples" class="btn btn-primary" style="color: white;">
        <i class="fas fa-download"></i> Download Filtered Samples
    </button>
    <span id="filtered-count" style="margin-left: 10px; color: #666;"></span>
</div>
<div class="table-responsive">
    <table id='myTable1' class="table table-hover table-sm stripe no-border">
        <thead>
            <tr>
                <th>Sample Name</th>
                <th>Feature Count</th>
                <th>Oncogenes</th>
                <th>Classifications</th>
                <!-- <th>Sample Page</th> -->
            </tr>
        </thead>
        <tbody>
            {% for sample in sample_data %}
            <tr>
                <td><a href="/project/{{project.linkid}}/sample/{{sample.Sample_name}}">{{ sample.Sample_name }}</a></td>
                <td>{{ sample.Features }}</td>
                <td>{{ sample.Oncogenes|join:", " }}</td>
                <td>{{ sample.Classifications_counted|join:", " }}</td>

                <!-- <td>{% for gene in sample.Oncogenes %}
                    {{ gene|wordwrap:5 }}
                {% endfor %} -->
                </td>
                <!-- <td><a target="_blank" href="/project/{{project.linkid}}/sample/{{sample.Sample_name}}"><i class="fa fa-link" aria-hidden="true" style="font-size:15px"></i></a></td> -->
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

    <br>
    <div id="accordion" >
    <div class="card">
        <style>
            .btn-link:not([aria-expanded="false"]).collapsed::before {
                content: "";
                display: inline-block;
                border-style: solid;
                border-width: 0.4em 0 0.4em 0.4em;
                border-color: transparent transparent transparent #000;
                margin-right: 0.5em;
                transform: rotate(0deg);
                vertical-align: middle;
            }

            .btn-link[aria-expanded="true"]::before {
                content: "";
                display: inline-block;
                border-style: solid;
                border-width: 0.4em 0 0.4em 0.4em;
                border-color: transparent transparent transparent #000;
                margin-right: 0.5em;
                transform: rotate(90deg);
                vertical-align: middle;
            }

            .btn-link:not([aria-expanded="true"]).collapsed::before {
                content: "";
                display: inline-block;
                border-style: solid;
                border-width: 0.4em 0 0.4em 0.4em;
                border-color: transparent transparent transparent #000;
                margin-right: 0.5em;
                transform: rotate(0deg);
                vertical-align: middle;
            }

            .table-not-striped tbody tr:nth-of-type(odd) {
                background-color: transparent!important;
            }
            .table-not-striped  th {
                background-color: #E6EFFB;
                color: #696a6c
            }
            .table-not-striped td {
                color: #696a6c
            }
        </style>

        <div class="card-header" id="headingToolVersions">
            <h4 class="mb-0">
                <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseToolVersions" aria-expanded="false" aria-controls="collapseToolVersions" style="padding: 0.25rem 0.5rem; font-weight: bold;">
                    Tool versions 
                </button>
            </h4>
        </div>
        <div id="collapseToolVersions" class="collapse" aria-labelledby="headingToolVersions" data-parent="#accordion">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <th scope="col">AmpliconSuite-pipeline</th>
                            <th scope="col">AmpliconArchitect</th>
                            <th scope="col">AmpliconClassifier</th>
                        </thead>
                        <tbody>
                            <tr>
                                <td scope="row">{{ project.ASP_version |default:"NA"  }}</td>
                                <td scope="row">{{ project.AA_version |default:"NA" }}</td>
                                <td scope="row">{{ project.AC_version |default:"NA"  }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    
    
        <div class="card-header" id="headingPrevVersions">
            <h4 class="mb-0">
                <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapsePrevVersions" aria-expanded="false" aria-controls="collapsePrevVersions" style="padding: 0.25rem 0.5rem; font-weight: bold;">
                    Project History ({{prev_versions_length}})
                </button>
            </h4>
        </div>


        <div id="collapsePrevVersions" class="collapse" aria-labelledby="headingPrevVersions" data-parent="#accordion">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <th scope="col">Date Created</th>
                            <th scope="col">Version</th>
                            <th scope="col">AS-p</th>
                            <th scope="col">AA</th>
                            <th scope="col">AC</th>
                            
                            <th scope="col">Download</th>
                        </thead>
                        <tbody>
                            {% for version in prev_versions %}

                            <tr>
                                <td class="date">{{ version.date }}</td>
                                <td scope="row">Project ID:
                                    <a href="/project/{{ version.linkid }}">{{ version.linkid }}</a>
                                    {% if version.linkid == proj_id %}
                                        <strong>(Currently viewing)</strong>
                                    {% endif %}
                                </td>
                                <td scope="row">{{ version.ASP_version }}</td>
                                <td scope="row">{{ version.AA_version }}</td>
                                <td scope="row">{{ version.AC_version }}</td>
                                <td scope="row">
                                    <a class="btn btn-primary" href="/project/{{ version.linkid }}/download" style="color: white; margin-bottom: 12px;">Download version</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    </div>



</div>

{% endblock %}
