<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URL Timing Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #stopBtn {
            background-color: #f44336;
        }
        #stopBtn:hover {
            background-color: #da190b;
        }
        .results {
            margin-top: 30px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 4px;
            display: none;
        }
        .results.show {
            display: block;
        }
        .results h2 {
            color: #333;
            margin-top: 0;
        }
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            background-color: white;
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
        }
        .stats-table th,
        .stats-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        .stats-table th {
            background-color: #4CAF50;
            color: white;
            font-weight: bold;
        }
        .stats-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .stats-table tr:hover {
            background-color: #f5f5f5;
        }
        .stats-table td:first-child {
            font-weight: bold;
            color: #555;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        .stat-row:last-child {
            border-bottom: none;
        }
        .stat-label {
            font-weight: bold;
            color: #555;
        }
        .stat-value {
            color: #333;
        }
        .progress {
            margin-top: 20px;
            display: none;
        }
        .progress.show {
            display: block;
        }
        .progress-bar {
            width: 100%;
            height: 30px;
            background-color: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background-color: #4CAF50;
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        .error {
            color: #f44336;
            margin-top: 10px;
            padding: 10px;
            background-color: #ffebee;
            border-radius: 4px;
            display: none;
        }
        .error.show {
            display: block;
        }
        .timings-list {
            margin-top: 15px;
            padding: 10px;
            background-color: white;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
        }
        .timing-item {
            padding: 5px;
            border-bottom: 1px solid #e0e0e0;
        }
        .timing-item:last-child {
            border-bottom: none;
        }
        .info {
            background-color: #e3f2fd;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #1565c0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>URL Timing Test</h1>
        
        <div class="info">
            <strong>Note:</strong> This tool measures the time it takes to fetch a URL.<br>
            <strong>Direct mode:</strong> Tests URLs from the same origin (no CORS issues).<br>
            <strong>Proxy mode:</strong> Check "Use Proxy" to test cross-origin URLs (e.g., test production from dev).
            The proxy will forward requests with browser-like headers.
        </div>

        <form id="timingForm">
            <div class="form-group">
                <label for="urlInput">URL to Test:</label>
                <input type="text" id="urlInput" name="url" 
                       placeholder="https://example.com/api/endpoint" 
                       required>
            </div>
            
            <div class="form-group">
                <label for="iterationsInput">Number of Iterations:</label>
                <input type="number" id="iterationsInput" name="iterations" 
                       value="10" min="1" max="100" required>
            </div>
            
            <div class="form-group">
                <label style="display: flex; align-items: center; font-weight: normal;">
                    <input type="checkbox" id="useProxy" name="useProxy" style="width: auto; margin-right: 8px;">
                    <span>Use Proxy (for testing cross-origin URLs like production from dev)</span>
                </label>
            </div>
            
            <button type="submit" id="startBtn">Start Test</button>
            <button type="button" id="stopBtn" style="display: none;">Stop Test</button>
        </form>

        <div class="error" id="errorDiv"></div>

        <div class="progress" id="progressDiv">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
        </div>

        <div class="results" id="resultsDiv">
            <h2>Results</h2>
            <p style="font-size: 14px; color: #666; margin-bottom: 10px;">
                Select the table below and copy (Ctrl+C / Cmd+C) to paste into Google Sheets
            </p>
            <table class="stats-table" id="statsTable">
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>URL</td>
                        <td id="testedUrl">-</td>
                    </tr>
                    <tr>
                        <td>Total Requests</td>
                        <td id="totalRequests">-</td>
                    </tr>
                    <tr>
                        <td>Successful</td>
                        <td id="successfulRequests">-</td>
                    </tr>
                    <tr>
                        <td>Failed</td>
                        <td id="failedRequests">-</td>
                    </tr>
                    <tr>
                        <td>Min Time</td>
                        <td id="minTime">-</td>
                    </tr>
                    <tr>
                        <td>Max Time</td>
                        <td id="maxTime">-</td>
                    </tr>
                    <tr>
                        <td>Mean Time</td>
                        <td id="meanTime">-</td>
                    </tr>
                    <tr>
                        <td>Median Time</td>
                        <td id="medianTime">-</td>
                    </tr>
                    <tr>
                        <td>Standard Deviation</td>
                        <td id="stdDev">-</td>
                    </tr>
                </tbody>
            </table>
            
            <h3>Individual Timings:</h3>
            <div class="timings-list" id="timingsList"></div>
        </div>

        <div style="margin-top: 30px; padding: 20px; background-color: #f9f9f9; border-radius: 4px;">
            <h2 style="color: #333; margin-top: 0;">Alternative: Browser Console Script</h2>
            <p style="color: #666; margin-bottom: 15px;">
                Copy and paste this script into your browser's console (F12) to run timing tests directly on any page without CORS issues.
                This method uses the page's origin for all requests.
            </p>
            <div style="position: relative;">
                <button id="copyScriptBtn" style="position: absolute; top: 10px; right: 10px; padding: 8px 16px; font-size: 14px;">
                    Copy Script
                </button>
                <pre id="consoleScript" style="background-color: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 4px; overflow-x: auto; margin: 0; padding-right: 100px;"><code>// URL Timing Test Script
// Usage: Change the URL and iterations below, then run this entire script in the console

(async function() {
    const url = window.location.href;  // Uses current page URL (change if needed)
    const iterations = 10;  // Change number of iterations
    
    console.log(`Starting timing test for ${url} with ${iterations} iterations...`);
    console.log('---------------------------------------------------');
    
    const timings = [];
    const errors = [];
    
    for (let i = 0; i < iterations; i++) {
        try {
            const startTime = performance.now();
            
            const response = await fetch(url, {
                method: 'GET',
                cache: 'no-cache',
                headers: {
                    'Cache-Control': 'no-cache',
                    'Pragma': 'no-cache'
                }
            });
            
            await response.text();
            const endTime = performance.now();
            const duration = endTime - startTime;
            
            if (response.ok) {
                timings.push(duration);
                console.log(`✓ Request ${i + 1}: ${duration.toFixed(2)} ms`);
            } else {
                errors.push(`Request ${i + 1}: HTTP ${response.status}`);
                console.error(`✗ Request ${i + 1}: HTTP ${response.status}`);
            }
        } catch (error) {
            errors.push(`Request ${i + 1}: ${error.message}`);
            console.error(`✗ Request ${i + 1}: ${error.message}`);
        }
        
        // Small delay between requests
        if (i < iterations - 1) {
            await new Promise(resolve => setTimeout(resolve, 100));
        }
    }
    
    console.log('---------------------------------------------------');
    
    if (timings.length > 0) {
        const sorted = [...timings].sort((a, b) => a - b);
        const n = sorted.length;
        const min = sorted[0];
        const max = sorted[n - 1];
        const mean = sorted.reduce((sum, val) => sum + val, 0) / n;
        const median = n % 2 === 0 ? 
            (sorted[n / 2 - 1] + sorted[n / 2]) / 2 : 
            sorted[Math.floor(n / 2)];
        const variance = sorted.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / n;
        const stdDev = Math.sqrt(variance);
        
        console.log('RESULTS:');
        console.log(`URL: ${url}`);
        console.log(`Total Requests: ${iterations}`);
        console.log(`Successful: ${timings.length}`);
        console.log(`Failed: ${errors.length}`);
        console.log(`Min Time: ${min.toFixed(2)} ms`);
        console.log(`Max Time: ${max.toFixed(2)} ms`);
        console.log(`Mean Time: ${mean.toFixed(2)} ms`);
        console.log(`Median Time: ${median.toFixed(2)} ms`);
        console.log(`Std Deviation: ${stdDev.toFixed(2)} ms`);
        
        // Create table data for easy copying to spreadsheet
        console.log('\n---------------------------------------------------');
        console.log('SPREADSHEET DATA (copy from here):');
        console.table([
            { Metric: 'URL', Value: url },
            { Metric: 'Total Requests', Value: iterations },
            { Metric: 'Successful', Value: timings.length },
            { Metric: 'Failed', Value: errors.length },
            { Metric: 'Min Time (ms)', Value: min.toFixed(2) },
            { Metric: 'Max Time (ms)', Value: max.toFixed(2) },
            { Metric: 'Mean Time (ms)', Value: mean.toFixed(2) },
            { Metric: 'Median Time (ms)', Value: median.toFixed(2) },
            { Metric: 'Std Deviation (ms)', Value: stdDev.toFixed(2) }
        ]);
    } else {
        console.error('No successful requests completed!');
        if (errors.length > 0) {
            console.error('Errors:', errors);
        }
    }
})();</code></pre>
            </div>
            <p style="color: #666; margin-top: 15px; font-size: 14px;">
                <strong>Instructions:</strong>
                <ol style="margin: 5px 0;">
                    <li>Open your browser's Developer Tools (Press F12 or right-click → Inspect)</li>
                    <li>Go to the "Console" tab</li>
                    <li>Click "Copy Script" button above or manually select and copy the entire script</li>
                    <li>Paste the script into the console</li>
                    <li>Edit the <code>url</code> and <code>iterations</code> values if desired</li>
                    <li>Press Enter to run the test</li>
                    <li>Results will be displayed in the console, including a table you can copy to a spreadsheet</li>
                </ol>
            </p>
        </div>
    </div>

    <script>
        // Copy script button functionality
        document.getElementById('copyScriptBtn').addEventListener('click', () => {
            const scriptText = document.getElementById('consoleScript').textContent;
            navigator.clipboard.writeText(scriptText).then(() => {
                const btn = document.getElementById('copyScriptBtn');
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                btn.style.backgroundColor = '#4CAF50';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.backgroundColor = '';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('Failed to copy. Please select and copy manually.');
            });
        });
    </script>

    <script>
        let isRunning = false;
        let shouldStop = false;

        document.getElementById('timingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (isRunning) {
                return;
            }

            const url = document.getElementById('urlInput').value.trim();
            const iterations = parseInt(document.getElementById('iterationsInput').value);

            // Reset UI
            document.getElementById('errorDiv').classList.remove('show');
            document.getElementById('errorDiv').textContent = '';
            document.getElementById('resultsDiv').classList.remove('show');
            document.getElementById('progressDiv').classList.add('show');
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('progressFill').textContent = '0%';
            document.getElementById('timingsList').innerHTML = '';
            
            // Show stop button, hide start button
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').style.display = 'inline-block';
            
            isRunning = true;
            shouldStop = false;

            try {
                await runTimingTest(url, iterations);
            } catch (error) {
                showError(error.message);
            } finally {
                isRunning = false;
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').style.display = 'none';
                document.getElementById('progressDiv').classList.remove('show');
            }
        });

        document.getElementById('stopBtn').addEventListener('click', () => {
            shouldStop = true;
            document.getElementById('stopBtn').disabled = true;
            showError('Test stopped by user');
        });

        async function runTimingTest(url, iterations) {
            const timings = [];
            const errors = [];
            const useProxy = document.getElementById('useProxy').checked;

            for (let i = 0; i < iterations; i++) {
                if (shouldStop) {
                    break;
                }

                // Update progress
                const progress = ((i / iterations) * 100).toFixed(0);
                document.getElementById('progressFill').style.width = progress + '%';
                document.getElementById('progressFill').textContent = progress + '%';

                try {
                    let duration;
                    let responseOk;
                    let statusCode;

                    if (useProxy) {
                        // Use proxy mode for cross-origin requests
                        const result = await fetchViaProxy(url);
                        duration = result.duration;
                        responseOk = result.ok;
                        statusCode = result.status;
                    } else {
                        // Use direct fetch for same-origin requests
                        const startTime = performance.now();
                        
                        const response = await fetch(url, {
                            method: 'GET',
                            cache: 'no-cache',
                            headers: {
                                'Cache-Control': 'no-cache',
                                'Pragma': 'no-cache'
                            }
                        });

                        // Read the response to ensure full download
                        await response.text();

                        const endTime = performance.now();
                        duration = endTime - startTime;
                        responseOk = response.ok;
                        statusCode = response.status;
                    }

                    if (responseOk) {
                        timings.push(duration);
                        addTimingToList(i + 1, duration, true);
                    } else {
                        errors.push(`Request ${i + 1}: HTTP ${statusCode}`);
                        addTimingToList(i + 1, duration, false, `HTTP ${statusCode}`);
                    }
                } catch (error) {
                    errors.push(`Request ${i + 1}: ${error.message}`);
                    addTimingToList(i + 1, 0, false, error.message);
                }

                // Small delay between requests to avoid overwhelming the server
                if (i < iterations - 1) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
            }

            // Update final progress
            if (!shouldStop) {
                document.getElementById('progressFill').style.width = '100%';
                document.getElementById('progressFill').textContent = '100%';
            }

            // Calculate statistics
            if (timings.length > 0) {
                const stats = calculateStats(timings);
                displayResults(stats, timings.length, errors.length, iterations);
            } else {
                showError('No successful requests completed. Check console for details.');
                if (errors.length > 0) {
                    console.error('Errors:', errors);
                }
            }
        }

        async function fetchViaProxy(url) {
            const response = await fetch('/url-timing-proxy/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ url: url })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Proxy request failed');
            }

            const data = await response.json();
            
            if (data.status === 0) {
                throw new Error(data.error || 'Request failed');
            }
            
            return data;
        }

        function calculateStats(timings) {
            const sorted = [...timings].sort((a, b) => a - b);
            const n = sorted.length;

            const min = sorted[0];
            const max = sorted[n - 1];
            const mean = sorted.reduce((sum, val) => sum + val, 0) / n;

            let median;
            if (n % 2 === 0) {
                median = (sorted[n / 2 - 1] + sorted[n / 2]) / 2;
            } else {
                median = sorted[Math.floor(n / 2)];
            }

            const variance = sorted.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / n;
            const stdDev = Math.sqrt(variance);

            return { min, max, mean, median, stdDev };
        }

        function displayResults(stats, successful, failed, total) {
            document.getElementById('testedUrl').textContent = document.getElementById('urlInput').value;
            document.getElementById('totalRequests').textContent = total;
            document.getElementById('successfulRequests').textContent = successful;
            document.getElementById('failedRequests').textContent = failed;
            document.getElementById('minTime').textContent = formatTime(stats.min);
            document.getElementById('maxTime').textContent = formatTime(stats.max);
            document.getElementById('meanTime').textContent = formatTime(stats.mean);
            document.getElementById('medianTime').textContent = formatTime(stats.median);
            document.getElementById('stdDev').textContent = formatTime(stats.stdDev);

            document.getElementById('resultsDiv').classList.add('show');
        }

        function formatTime(ms) {
            if (ms < 1000) {
                return ms.toFixed(2) + ' ms';
            } else {
                return (ms / 1000).toFixed(2) + ' s';
            }
        }

        function addTimingToList(requestNum, duration, success, errorMsg = '') {
            const timingsList = document.getElementById('timingsList');
            const item = document.createElement('div');
            item.className = 'timing-item';
            
            if (success) {
                item.textContent = `Request ${requestNum}: ${formatTime(duration)}`;
                item.style.color = '#4CAF50';
            } else {
                item.textContent = `Request ${requestNum}: Failed - ${errorMsg}`;
                item.style.color = '#f44336';
            }
            
            timingsList.appendChild(item);
            timingsList.scrollTop = timingsList.scrollHeight;
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorDiv');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
        }
    </script>
</body>
</html>

